<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>KubernetesBinaryInstallation HA | William&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="二进制方式部署kubernetes高可用集群">
<meta name="author" content="deemoprobe">
<link rel="canonical" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesbinaryinstallation-ha/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.86a98c52ea686f5031e49bb9626478e3e3886f043822229977ef4042e6f8bbb3.css" integrity="sha256-hqmMUupob1Ax5Ju5YmR44&#43;OIbwQ4IiKZd&#43;9AQub4u7M=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://deemoprobe.github.io/img/favicon/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://deemoprobe.github.io/img/favicon/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://deemoprobe.github.io/img/favicon/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://deemoprobe.github.io/img/favicon/apple-touch-icon.png">
<link rel="mask-icon" href="https://deemoprobe.github.io/img/favicon/android-chrome-192x192.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="KubernetesBinaryInstallation HA" />
<meta property="og:description" content="二进制方式部署kubernetes高可用集群" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesbinaryinstallation-ha/" />
<meta property="og:image" content="https://deemoprobe.github.io/img/kubernetes.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-29T14:17:51+08:00" />
<meta property="article:modified_time" content="2023-04-29T14:17:51+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://deemoprobe.github.io/img/kubernetes.png" />
<meta name="twitter:title" content="KubernetesBinaryInstallation HA"/>
<meta name="twitter:description" content="二进制方式部署kubernetes高可用集群"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "📚文章",
          "item": "https://deemoprobe.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "👨🏻‍💻 技术",
          "item": "https://deemoprobe.github.io/posts/tech/"
        },

        {
          "@type": "ListItem",
          "position":  3 ,
          "name": "Kubernetes",
          "item": "https://deemoprobe.github.io/posts/tech/kubernetes/"
        }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "KubernetesBinaryInstallation HA",
      "item": "https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesbinaryinstallation-ha/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "KubernetesBinaryInstallation HA",
  "name": "KubernetesBinaryInstallation HA",
  "description": "二进制方式部署kubernetes高可用集群",
  "keywords": [
    ""
  ],
  "articleBody": "环境说明 宿主机系统：Windows 10 虚拟机版本：VMware® Workstation 16 Pro IOS镜像版本：CentOS Linux release 7.9.2009 Kubernetes版本：1.26.4 Runtime：Containerd v1.6.20 Etcd版本：3.5.6 集群操作用户：root 更新时间：2023-04-21 CentOS7安装请参考博客文章：LINUX之VMWARE WORKSTATION安装CENTOS-7\n资源分配 网段划分\nKubernetes集群需要规划三个网段：\n宿主机网段：Kubernetes集群节点的网段 Pod网段：集群内Pod的网段，相当于容器的IP Service网段：集群内服务发现使用的网段，service用于集群容器通信 生产环境根据申请到的IP资源进行分配即可，原则是三个网段不允许有重合IP。IP网段计算可以参考：在线IP地址计算。本文虚拟机练习环境IP地址网段分配如下：\n宿主机网段：192.168.43.1/24 Pod网段：172.16.0.0/12 Service：10.96.0.0/12 节点分配\n采用3管理节点2工作节点的高可用Kubernetes集群模式：\nk8s-master01/k8s-master02/k8s-master03 集群的Master节点 三个master节点同时做etcd集群 k8s-node01/k8s-node02 集群的Node节点 k8s-master-vip做高可用k8s-master01~03的VIP，不占用物理资源 主机节点名称 IP CPU核心数 内存大小 磁盘大小 k8s-master-vip 192.168.43.200 / / / k8s-master01 192.168.43.201 2 2G 40G k8s-master02 192.168.43.202 2 2G 40G k8s-master03 192.168.43.203 2 2G 40G k8s-node01 192.168.43.204 2 2G 40G k8s-node02 192.168.43.205 2 2G 40G 操作步骤 标题后小括号注释表明操作范围：\nALL 所有节点（k8s-master01/k8s-master02/k8s-master03/k8s-node01/k9s-node02）执行 Master 只需要在master节点（k8s-master01/k8s-master02/k8s-master03）执行 Node 只需要在node节点（k8s-node01/k8s-node02）执行 已标注的个别命令只需要在某一台机器执行，会在操作前说明 未标注的会在操作时说明 使用cat \u003c\u003c \"EOF\" \u003e\u003e file或cat \u003e\u003e file \u003c\u003c \"EOF\"添加文件内容注意cat后面的EOF一定要加上双引号（标准输入的），否则不会保留输入时的缩进格式而且会直接解析输入时的变量，进而造成文件可读性差甚至不可用；同时注意文件的\u003e重写与\u003e\u003e追加。虽然单独转义输入时的变量也能避免变量被解析，但是不推荐，漏转义会造成不必要的麻烦。\n准备工作(ALL) 添加主机信息、关闭防火墙、关闭swap、关闭SELinux、dnsmasq、NetworkManager\n# 添加主机信息 cat \u003c\u003c \"EOF\" \u003e\u003e /etc/hosts 192.168.43.200 k8s-master-vip 192.168.43.201 k8s-master01 192.168.43.202 k8s-master02 192.168.43.203 k8s-master03 192.168.43.204 k8s-node01 192.168.43.205 k8s-node02 EOF # 关闭防火墙、dnsmasq、NetworkManager，--now参数表示关闭服务并移除开机自启 # 这些服务是否可以关闭视情况而定，本文是虚拟机实践，没有用到这些服务 systemctl disable --now firewalld systemctl disable --now dnsmasq systemctl disable --now NetworkManager # 关闭swap，并注释fstab文件swap所在行 swapoff -a sed -i '/swap/s/^\\(.*\\)$/#\\1/g' /etc/fstab # 关闭SELinux，并更改selinux配置文件 setenforce 0 sed -i \"s/=enforcing/=disabled/g\" /etc/selinux/config 值得注意的是/etc/sysconfig/selinux文件是/etc/selinux/config文件的软连接，用sed -i命令修改软连接文件会破坏软连接属性，将/etc/sysconfig/selinux变为一个独立的文件，即使该文件被修改了，但源文件/etc/selinux/config配置是没变的。此外，使用vim等编辑器编辑源文件或链接文件（编辑模式不会修改文件属性）修改也可以。软链接原理可参考博客：LINUX之INODE详解\n# 默认的yum源太慢，更新为阿里源，同时用sed命令删除文件中不需要的两个URL的行 curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo sed -i -e '/mirrors.cloud.aliyuncs.com/d' -e '/mirrors.aliyuncs.com/d' /etc/yum.repos.d/CentOS-Base.repo # 安装常用工具包 yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y # 配置ntpdate，同步服务器时间 rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm yum install ntpdate -y # 同步时区和时间 ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime echo 'Asia/Shanghai' \u003e/etc/timezone ntpdate time2.aliyun.com # 可以加入计划任务，保证集群时钟是一致的 # /var/spool/cron/root文件也是crontab -e写入的文件 # crontab执行日志查看可用：tail -f /var/log/cron cat \u003c\u003c \"EOF\" \u003e\u003e /var/spool/cron/root */5 * * * * /usr/sbin/ntpdate time2.aliyun.com EOF # 须知：如果设置了定时任务，会经常收到提示“You have new mail in /var/spool/mail/root” # （可选）禁用提示：echo \"unset MAILCHECK\" \u003e\u003e ~/.bashrc;source ~/.bashrc # 禁用提示后/var/spool/mail/root文件依旧会记录root操作日志，可随时查看 # 保证文件句柄不会限制集群的可持续发展，配置limits ulimit -SHn 65500 cat \u003c\u003c \"EOF\" \u003e\u003e /etc/security/limits.conf * soft nofile 65500 * hard nofile 65500 * soft nproc 65500 * hard nproc 65500 * soft memlock unlimited * hard memlock unlimited EOF # 配置免密登录，k8s-master01到其他节点 # 生成密钥对（在k8s-master01节点配置即可） ssh-keygen -t rsa # 拷贝公钥到其他节点，首次需要认证一下各个节点的root密码，以后就可以免密ssh到其他节点 for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do ssh-copy-id -i .ssh/id_rsa.pub $i;done # 克隆二进制仓库1.26分支的文件（k8s-master01上操作即可） cd /root;git clone https://gitee.com/deemoprobe/k8s-ha-install.git -b manual-installation-v1.26.x # 所有节点系统升级 yum update --exclude=kernel* -y 升级内核，4.17以下的内核cgroup存在内存泄漏的BUG，具体分析过程浏览器搜Kubernetes集群为什么要升级内核会有很多文章讲解\n内核备用下载（下载到本地后上传到服务器，尽量不要用wget）：\nkernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm # 下载4.19版本内核，如果无法下载，可以用上面提供的备用下载 cd /root wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm # 可以在k8s-master01节点下载后，免密传到其他节点 for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do scp kernel-ml-* $i:/root;done # 所有节点安装内核 cd /root \u0026\u0026 yum localinstall -y kernel-ml* # 所有节点更改内核启动顺序 grub2-set-default 0 \u0026\u0026 grub2-mkconfig -o /etc/grub2.cfg grubby --args=\"user_namespace.enable=1\" --update-kernel=\"$(grubby --default-kernel)\" # 查看默认内核，并重启节点 grubby --default-kernel reboot # 确认内核版本 uname -a # （可选）删除老版本的内核，避免以后被升级取代默认的开机4.19内核 rpm -qa | grep kernel yum remove -y kernel-3* # 升级系统软件包（如果跳过内核升级加参数 --exclude=kernel*） yum update -y # 安装IPVS相关工具，由于IPVS在资源消耗和性能上均已明显优于iptables，所以推荐开启 # 具体原因可参考官网介绍 https://kubernetes.io/zh/blog/2018/07/09/ipvs-based-in-cluster-load-balancing-deep-dive/ yum install ipvsadm ipset sysstat conntrack libseccomp -y # 加载模块，最后一条4.18及以下内核使用nf_conntrack_ipv4，4.19已改为nf_conntrack modprobe -- ip_vs modprobe -- ip_vs_rr modprobe -- ip_vs_wrr modprobe -- ip_vs_sh modprobe -- nf_conntrack # 编写参数文件 cat \u003c\u003c \"EOF\" \u003e /etc/modules-load.d/ipvs.conf ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp ip_vs_sh nf_conntrack ip_tables ip_set xt_set ipt_set ipt_rpfilter ipt_REJECT ipip EOF # systemd-modules-load加入开机自启 systemctl enable --now systemd-modules-load # 自定义内核参数优化配置文件 cat \u003c\u003c \"EOF\" \u003e /etc/sysctl.d/kubernetes.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-ip6tables = 1 fs.may_detach_mounts = 1 net.ipv4.conf.all.route_localnet = 1 vm.overcommit_memory=1 vm.panic_on_oom=0 fs.inotify.max_user_watches=89100 fs.file-max=52706963 fs.nr_open=52706963 net.netfilter.nf_conntrack_max=2310720 net.ipv4.tcp_keepalive_time = 600 net.ipv4.tcp_keepalive_probes = 3 net.ipv4.tcp_keepalive_intvl =15 net.ipv4.tcp_max_tw_buckets = 36000 net.ipv4.tcp_tw_reuse = 1 net.ipv4.tcp_max_orphans = 327680 net.ipv4.tcp_orphan_retries = 3 net.ipv4.tcp_syncookies = 1 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.ip_conntrack_max = 65536 net.ipv4.tcp_max_syn_backlog = 16384 net.ipv4.tcp_timestamps = 0 net.core.somaxconn = 16384 EOF # 加载 sysctl --system # 重启查看IPVS模块是否依旧加载 reboot lsmod | grep -e ip_vs -e nf_conntrack 保证每台服务器中IPVS加载成功，以k8s-master01为例，如图： 部署Containerd(ALL) Kubernetes1.24版本以后将不再支持Docker作为Runtime，本文安装使用Containerd作为Runtime。\n# 配置阿里docker源 yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo # 安装最新版本docker和containerd.io，安装docker是为了使用docker CLI yum install docker-ce docker-ce-cli containerd.io -y # （可选）也可以按需安装指定版本 yum install docker-ce-20.10.* docker-ce-cli-20.10.* containerd -y # 配置Containerd模块 cat \u003c\u003c \"EOF\" \u003e /etc/modules-load.d/containerd.conf overlay br_netfilter EOF # 加载模块 modprobe -- overlay modprobe -- br_netfilter # 配置内核参数 cat \u003c\u003c \"EOF\" \u003e /etc/sysctl.d/containerd.conf net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 EOF # 加载内核参数 sysctl --system # 生成默认配置文件 mkdir -p /etc/containerd containerd config default | tee /etc/containerd/config.toml # 更改Cgroup为Systemd，在containerd.runtimes.runc.options行后的SystemdCgroup = false修改为true，如果配置项不存在就自行添加，缩进俩空格添加SystemdCgroup = true一行 vim /etc/containerd/config.toml ... [plugins.\"io.containerd.grpc.v1.cri\".containerd.runtimes.runc.options] SystemdCgroup = true ... # 将sandbox_image的Pause镜像地址改成国内：registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7 vim /etc/containerd/config.toml sandbox_image = \"registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7\" # （可选）也可以在k8s-master01编辑/etc/containerd/config.toml文件后，将编辑后同名文件同步到其他服务器，自动覆盖 for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do scp /etc/containerd/config.toml $i:/etc/containerd/config.toml;done # 查看确认是否配置成功 cat /etc/containerd/config.toml | grep -e Systemd -e sandbox_image # 启动并加入开机自启 systemctl daemon-reload systemctl enable --now containerd # containerd运行时的CLI是ctr [root@k8s-master01 ~]# ctr images ls REF TYPE DIGEST SIZE PLATFORMS LABELS [root@k8s-master01 ~]# ctr version Client: Version: 1.6.20 Revision: 2806fc1057397dbaeefbea0e4e17bddfbd388f38 Go version: go1.19.7 Server: Version: 1.6.20 Revision: 2806fc1057397dbaeefbea0e4e17bddfbd388f38 UUID: 9958928e-300c-4778-b83c-6c0073414f3e # 配置crictl连接的运行时socket接口（指向containerd's GRPC server：/run/containerd/containerd.sock） # crictl 默认连接到unix:///var/run/dockershim.sock cat \u003c\u003c \"EOF\" \u003e /etc/crictl.yaml runtime-endpoint: unix:///run/containerd/containerd.sock image-endpoint: unix:///run/containerd/containerd.sock timeout: 10 debug: false EOF # crictl按需选择，https://github.com/kubernetes-sigs/cri-tools/releases # containerd容器管理CLI是crictl，该命令使用和docker命令类似，下载包上传到k8s-master01 [root@k8s-master01 ~]# tar -zxvf crictl-v1.27.0-linux-amd64.tar.gz [root@k8s-master01 ~]# mv crictl /usr/local/bin/ [root@k8s-master01 ~]# crictl version Version: 0.1.0 RuntimeName: containerd RuntimeVersion: 1.6.20 RuntimeApiVersion: v1 # 二进制可执行文件发送到其他节点 [root@k8s-master01 ~]# for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do scp /usr/local/bin/crictl $i:/usr/local/bin/;done crictl 是CRI（Container Runtime Interface）兼容的容器运行时的CLI（Command-Line Interface）。可以这个命令来检查和调试 Kubernetes 节点上的容器运行时和应用程序。介绍和安装方式可见：critools或Kubernetes官方介绍\n二进制包和证书 k8s-master01节点上下载并安装Kubernetes二进制安装包（server-binaries，选择对应的架构即可）和ETCD二进制安装包，可在GitHub上查看Kubernetes1.23.x版本的信息，官方GitHub-Kubernetes1.23版本链接，ETCD官方链接\n# 以下在k8s-master01执行 # 下载太慢的话可以在相应链接网页上下载好传到服务器 wget https://dl.k8s.io/v1.26.4/kubernetes-server-linux-amd64.tar.gz wget https://github.com/etcd-io/etcd/releases/download/v3.5.6/etcd-v3.5.6-linux-amd64.tar.gz # 解压安装，--strip-components=N表示解压时忽略解压后的N层目录，直接获取N层目录后的目标文件。kubernetes/server/bin/是三层，etcd-v3.5.6-linux-amd64/是一层 tar -zxvf kubernetes-server-linux-amd64.tar.gz --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} tar -zxvf etcd-v3.5.6-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.6-linux-amd64/etcd{,ctl} # 确认版本 kubectl version kubelet --version etcdctl version # 拷贝组件到其他节点，Node节点只需要kubelet和kube-proxy for i in k8s-master02 k8s-master03; do scp /usr/local/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy} $i:/usr/local/bin/; scp /usr/local/bin/etcd* $i:/usr/local/bin/; done for i in k8s-node01 k8s-node02; do scp /usr/local/bin/kube{let,-proxy} $i:/usr/local/bin/; done 配置证书 # master节点创建etcd证书目录 mkdir -p /etc/etcd/ssl # 所有节点创建pki证书目录和CNI目录（后面calico使用） mkdir -p /etc/kubernetes/pki mkdir -p /opt/cni/bin # 以下在k8s-master01操作 # 安装证书生成工具，如果速度慢可以浏览器下载后上传至服务器改名即可 wget \"https://pkg.cfssl.org/R1.2/cfssl_linux-amd64\" -O /usr/local/bin/cfssl wget \"https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64\" -O /usr/local/bin/cfssljson chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson # 在master01节点生成etcd证书 cd /root/k8s-ha-install/pki cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca cfssl gencert \\ -ca=/etc/etcd/ssl/etcd-ca.pem \\ -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \\ -config=ca-config.json \\ -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.43.201,192.168.43.202,192.168.43.203 \\ -profile=kubernetes \\ etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd # 复制etcd证书到其他master节点 for i in k8s-master02 k8s-master03; do for FILE in etcd-ca-key.pem etcd-ca.pem etcd-key.pem etcd.pem; do scp /etc/etcd/ssl/${FILE} $i:/etc/etcd/ssl/${FILE} done done # 生成Kubernetes集群ca证书 cd /root/k8s-ha-install/pki cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca # k8s service网段10.96.0.0/12，填入网段第一个IP；集群VIP地址192.168.43.200 cfssl gencert -ca=/etc/kubernetes/pki/ca.pem -ca-key=/etc/kubernetes/pki/ca-key.pem -config=ca-config.json -hostname=10.96.0.1,192.168.43.200,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.43.201,192.168.43.202,192.168.43.203 -profile=kubernetes apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver # 生成apiserver的第三方组件使用的聚合证书，告警可以忽略 cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca cfssl gencert -ca=/etc/kubernetes/pki/front-proxy-ca.pem -ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem -config=ca-config.json -profile=kubernetes front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client # 生成controller-manager证书 cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager # 设置集群信息，集群名：kubernetes server：https://192.168.43.200:8443 # 如果不是高可用集群，192.168.43.200:8443改为master01的地址，8443改为apiserver的端口，默认是6443 kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.43.200:8443 \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # 设置上下文信息，context为system:kube-controller-manager@kubernetes kubectl config set-context system:kube-controller-manager@kubernetes \\ --cluster=kubernetes \\ --user=system:kube-controller-manager \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # 设置用户认证信息，用户为system:kube-controller-manager kubectl config set-credentials system:kube-controller-manager \\ --client-certificate=/etc/kubernetes/pki/controller-manager.pem \\ --client-key=/etc/kubernetes/pki/controller-manager-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # 设置默认集群环境 kubectl config use-context system:kube-controller-manager@kubernetes \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig # 生成scheduler证书 cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler # 同样的，scheduler需要和controller-manager设置相同的集群上下文等信息 kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/pki/ca.pem \\ --embed-certs=true \\ --server=https://192.168.43.200:8443 \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config set-credentials system:kube-scheduler \\ --client-certificate=/etc/kubernetes/pki/scheduler.pem \\ --client-key=/etc/kubernetes/pki/scheduler-key.pem \\ --embed-certs=true \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config set-context system:kube-scheduler@kubernetes \\ --cluster=kubernetes \\ --user=system:kube-scheduler \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig kubectl config use-context system:kube-scheduler@kubernetes \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig # 配置admin证书，以及集群上下文等信息 cfssl gencert \\ -ca=/etc/kubernetes/pki/ca.pem \\ -ca-key=/etc/kubernetes/pki/ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes \\ admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.pem --embed-certs=true --server=https://192.168.43.200:8443 --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config set-credentials kubernetes-admin --client-certificate=/etc/kubernetes/pki/admin.pem --client-key=/etc/kubernetes/pki/admin-key.pem --embed-certs=true --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config set-context kubernetes-admin@kubernetes --cluster=kubernetes --user=kubernetes-admin --kubeconfig=/etc/kubernetes/admin.kubeconfig kubectl config use-context kubernetes-admin@kubernetes --kubeconfig=/etc/kubernetes/admin.kubeconfig # 创建ServiceAccount密钥对 openssl genrsa -out /etc/kubernetes/pki/sa.key 2048 openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub # 拷贝证书到其他master节点 for i in k8s-master02 k8s-master03; do for FILE in $(ls /etc/kubernetes/pki | grep -v etcd); do scp /etc/kubernetes/pki/${FILE} $i:/etc/kubernetes/pki/${FILE}; done; for FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do scp /etc/kubernetes/${FILE} $i:/etc/kubernetes/${FILE}; done; done # 查看证书数量是否为23 ls /etc/kubernetes/pki/ | wc -l 23 ETCD集群(Master) 如果Etcd集群服务器和Kubernetes集群服务器不重合（即独立的Etcd集群），需要根据实际情况配置集群IP。\n# master01 cat \u003c\u003c \"EOF\" \u003e /etc/etcd/etcd.config.yml name: 'k8s-master01' data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: 'https://192.168.43.201:2380' listen-client-urls: 'https://192.168.43.201:2379,http://127.0.0.1:2379' max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: 'https://192.168.43.201:2380' advertise-client-urls: 'https://192.168.43.201:2379' discovery: discovery-fallback: 'proxy' discovery-proxy: discovery-srv: initial-cluster: 'k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380' initial-cluster-token: 'etcd-k8s-cluster' initial-cluster-state: 'new' strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: 'off' proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true peer-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' peer-client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false EOF # master02 cat \u003c\u003c \"EOF\" \u003e /etc/etcd/etcd.config.yml name: 'k8s-master02' data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: 'https://192.168.43.202:2380' listen-client-urls: 'https://192.168.43.202:2379,http://127.0.0.1:2379' max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: 'https://192.168.43.202:2380' advertise-client-urls: 'https://192.168.43.202:2379' discovery: discovery-fallback: 'proxy' discovery-proxy: discovery-srv: initial-cluster: 'k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380' initial-cluster-token: 'etcd-k8s-cluster' initial-cluster-state: 'new' strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: 'off' proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true peer-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' peer-client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false EOF # master03 cat \u003c\u003c \"EOF\" \u003e /etc/etcd/etcd.config.yml name: 'k8s-master03' data-dir: /var/lib/etcd wal-dir: /var/lib/etcd/wal snapshot-count: 5000 heartbeat-interval: 100 election-timeout: 1000 quota-backend-bytes: 0 listen-peer-urls: 'https://192.168.43.203:2380' listen-client-urls: 'https://192.168.43.203:2379,http://127.0.0.1:2379' max-snapshots: 3 max-wals: 5 cors: initial-advertise-peer-urls: 'https://192.168.43.203:2380' advertise-client-urls: 'https://192.168.43.203:2379' discovery: discovery-fallback: 'proxy' discovery-proxy: discovery-srv: initial-cluster: 'k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380' initial-cluster-token: 'etcd-k8s-cluster' initial-cluster-state: 'new' strict-reconfig-check: false enable-v2: true enable-pprof: true proxy: 'off' proxy-failure-wait: 5000 proxy-refresh-interval: 30000 proxy-dial-timeout: 1000 proxy-write-timeout: 5000 proxy-read-timeout: 0 client-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true peer-transport-security: cert-file: '/etc/kubernetes/pki/etcd/etcd.pem' key-file: '/etc/kubernetes/pki/etcd/etcd-key.pem' peer-client-cert-auth: true trusted-ca-file: '/etc/kubernetes/pki/etcd/etcd-ca.pem' auto-tls: true debug: false log-package-levels: log-outputs: [default] force-new-cluster: false EOF # 在所有master节点创建etcd服务并启动 cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/etcd.service [Unit] Description=Etcd Service Documentation=https://coreos.com/etcd/docs/latest/ After=network.target [Service] Type=notify ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml Restart=on-failure RestartSec=10 LimitNOFILE=65536 [Install] WantedBy=multi-user.target Alias=etcd3.service EOF # 所有Master节点创建etcd证书目录并链接证书，否则启动会失败 mkdir /etc/kubernetes/pki/etcd ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/ # 启动 systemctl daemon-reload \u0026\u0026 systemctl enable --now etcd # 查看etcd集群状态如下即可 ETCDCTL_API=3 etcdctl --endpoints=\"192.168.43.203:2379,192.168.43.202:2379,192.168.43.201:2379\" --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem endpoint status --write-out=table +---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS | +---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ | 192.168.43.203:2379 | fd1372a073304e | 3.5.1 | 20 kB | false | false | 2 | 9 | 9 | | | 192.168.43.202:2379 | 837ce9c47e0719eb | 3.5.1 | 20 kB | false | false | 2 | 9 | 9 | | | 192.168.43.201:2379 | e9bf8d99824c9061 | 3.5.1 | 20 kB | true | false | 2 | 9 | 9 | | +---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+ 高可用组件(Master) # 所有master节点安装Keepalived和haproxy，并创建配置文件目录 yum install keepalived haproxy -y mkdir /etc/haproxy mkdir /etc/keepalived # 为所有master节点添加haproxy配置，配置都一样，检查最后三行主机名和IP地址对应上就行 cat \u003c\u003c \"EOF\" \u003e /etc/haproxy/haproxy.cfg global maxconn 2000 ulimit-n 16384 log 127.0.0.1 local0 err stats timeout 30s defaults log global mode http option httplog timeout connect 5000 timeout client 50000 timeout server 50000 timeout http-request 15s timeout http-keep-alive 15s frontend monitor-in bind *:33305 mode http option httplog monitor-uri /monitor frontend k8s-master bind 0.0.0.0:8443 bind 127.0.0.1:8443 mode tcp option tcplog tcp-request inspect-delay 5s default_backend k8s-master backend k8s-master mode tcp option tcplog option tcp-check balance roundrobin default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100 server k8s-master01 192.168.43.201:6443 check server k8s-master02 192.168.43.202:6443 check server k8s-master03 192.168.43.203:6443 check EOF # keepalived配置不一样，注意区分网卡名、IP地址和虚拟IP地址 # 检查服务器网卡名 ip a 或 ifconfig # k8s-master01 Keepalived配置 cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL script_user root enable_script_security } vrrp_script chk_apiserver { script \"/etc/keepalived/check_apiserver.sh\" interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state MASTER interface ens33 mcast_src_ip 192.168.43.201 virtual_router_id 51 priority 101 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.43.200 } track_script { chk_apiserver } } EOF # k8s-master02 Keepalived配置 cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL script_user root enable_script_security } vrrp_script chk_apiserver { script \"/etc/keepalived/check_apiserver.sh\" interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state BACKUP interface ens33 mcast_src_ip 192.168.43.202 virtual_router_id 51 priority 100 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.43.200 } track_script { chk_apiserver } } EOF # k8s-master03 Keepalived配置 cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/keepalived.conf ! Configuration File for keepalived global_defs { router_id LVS_DEVEL script_user root enable_script_security } vrrp_script chk_apiserver { script \"/etc/keepalived/check_apiserver.sh\" interval 5 weight -5 fall 2 rise 1 } vrrp_instance VI_1 { state BACKUP interface ens33 mcast_src_ip 192.168.43.203 virtual_router_id 51 priority 100 advert_int 2 authentication { auth_type PASS auth_pass K8SHA_KA_AUTH } virtual_ipaddress { 192.168.43.200 } track_script { chk_apiserver } } EOF # 所有master节点配置Keepalived健康检查脚本 cat \u003c\u003c \"EOF\" \u003e /etc/keepalived/check_apiserver.sh #!/bin/bash err=0 for k in $(seq 1 3) do check_code=$(pgrep haproxy) if [[ $check_code == \"\" ]]; then err=$(expr $err + 1) sleep 1 continue else err=0 break fi done if [[ $err != \"0\" ]]; then echo \"systemctl stop keepalived\" /usr/bin/systemctl stop keepalived exit 1 else exit 0 fi EOF # 赋予可执行权限 chmod +x /etc/keepalived/check_apiserver.sh # 启动haproxy和Keepalived并加入开机启动 systemctl daemon-reload \u0026\u0026 systemctl enable --now haproxy \u0026\u0026 systemctl enable --now keepalived # 检查服务是否正常 # 这种告警可以忽略：Mar 06 14:03:35 k8s-master01 haproxy-systemd-wrapper[1981]: [WARNING] 064/140335 (1982) : config : frontend 'GLOBAL' has no 'bind' systemctl status haproxy systemctl status keepalived # 测试一波 telnet k8s-master-vip 8443 ping k8s-master-vip 配置集群组件 # 所有节点创建以下集群资源目录 mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes Apiserver(Master)\n所有master节点配置kube-apiserver服务 # service网段为10.96.0.0/12，可自行设置，其他参数按需配置即可 # master01配置 cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-apiserver.service [Unit] Description=Kubernetes API Server Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-apiserver \\ --v=2 \\ --allow-privileged=true \\ --bind-address=0.0.0.0 \\ --secure-port=6443 \\ --advertise-address=192.168.43.201 \\ --service-cluster-ip-range=10.96.0.0/12 \\ --service-node-port-range=30000-32767 \\ --etcd-servers=https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 \\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\ --service-account-key-file=/etc/kubernetes/pki/sa.pub \\ --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \\ --service-account-issuer=https://kubernetes.default.svc.cluster.local \\ --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\ --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \\ --authorization-mode=Node,RBAC \\ --enable-bootstrap-token-auth=true \\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\ --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\ --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\ --requestheader-allowed-names=aggregator \\ --requestheader-group-headers=X-Remote-Group \\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\ --requestheader-username-headers=X-Remote-User # --token-auth-file=/etc/kubernetes/token.csv Restart=on-failure RestartSec=10s LimitNOFILE=65535 [Install] WantedBy=multi-user.target EOF # master02配置 cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-apiserver.service [Unit] Description=Kubernetes API Server Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-apiserver \\ --v=2 \\ --allow-privileged=true \\ --bind-address=0.0.0.0 \\ --secure-port=6443 \\ --advertise-address=192.168.43.202 \\ --service-cluster-ip-range=10.96.0.0/12 \\ --service-node-port-range=30000-32767 \\ --etcd-servers=https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 \\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\ --service-account-key-file=/etc/kubernetes/pki/sa.pub \\ --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \\ --service-account-issuer=https://kubernetes.default.svc.cluster.local \\ --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\ --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \\ --authorization-mode=Node,RBAC \\ --enable-bootstrap-token-auth=true \\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\ --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\ --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\ --requestheader-allowed-names=aggregator \\ --requestheader-group-headers=X-Remote-Group \\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\ --requestheader-username-headers=X-Remote-User # --token-auth-file=/etc/kubernetes/token.csv Restart=on-failure RestartSec=10s LimitNOFILE=65535 [Install] WantedBy=multi-user.target EOF # master03配置 cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-apiserver.service [Unit] Description=Kubernetes API Server Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-apiserver \\ --v=2 \\ --allow-privileged=true \\ --bind-address=0.0.0.0 \\ --secure-port=6443 \\ --advertise-address=192.168.43.203 \\ --service-cluster-ip-range=10.96.0.0/12 \\ --service-node-port-range=30000-32767 \\ --etcd-servers=https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 \\ --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem \\ --etcd-certfile=/etc/etcd/ssl/etcd.pem \\ --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\ --client-ca-file=/etc/kubernetes/pki/ca.pem \\ --tls-cert-file=/etc/kubernetes/pki/apiserver.pem \\ --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem \\ --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem \\ --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem \\ --service-account-key-file=/etc/kubernetes/pki/sa.pub \\ --service-account-signing-key-file=/etc/kubernetes/pki/sa.key \\ --service-account-issuer=https://kubernetes.default.svc.cluster.local \\ --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \\ --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota \\ --authorization-mode=Node,RBAC \\ --enable-bootstrap-token-auth=true \\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\ --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem \\ --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem \\ --requestheader-allowed-names=aggregator \\ --requestheader-group-headers=X-Remote-Group \\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\ --requestheader-username-headers=X-Remote-User # --token-auth-file=/etc/kubernetes/token.csv Restart=on-failure RestartSec=10s LimitNOFILE=65535 [Install] WantedBy=multi-user.target EOF # 启动kube-apiserver systemctl daemon-reload \u0026\u0026 systemctl enable --now kube-apiserver ControllerManager(Master)\n所有Master节点配置kube-controller-manager服务，配置都一样\n# Pod网段是172.16.0.0/12，可按需更改，不要和其他在用网段冲突即可 # 给所有master节点配置服务 cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-controller-manager.service [Unit] Description=Kubernetes Controller Manager Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-controller-manager \\ --v=2 \\ --root-ca-file=/etc/kubernetes/pki/ca.pem \\ --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\ --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\ --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\ --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\ --feature-gates=LegacyServiceAccountTokenNoAutoGeneration=false \\ --leader-elect=true \\ --use-service-account-credentials=true \\ --node-monitor-grace-period=40s \\ --node-monitor-period=5s \\ --pod-eviction-timeout=2m0s \\ --controllers=*,bootstrapsigner,tokencleaner \\ --allocate-node-cidrs=true \\ --cluster-cidr=172.16.0.0/12 \\ --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \\ --node-cidr-mask-size=24 Restart=always RestartSec=10s [Install] WantedBy=multi-user.target EOF # 启动 systemctl daemon-reload \u0026\u0026 systemctl enable --now kube-controller-manager Scheduler(Master)\n所有Master节点配置kube-scheduler服务，配置都一样\ncat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-scheduler.service [Unit] Description=Kubernetes Scheduler Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-scheduler \\ --v=2 \\ --leader-elect=true \\ --authentication-kubeconfig=/etc/kubernetes/scheduler.kubeconfig \\ --authorization-kubeconfig=/etc/kubernetes/scheduler.kubeconfig \\ --kubeconfig=/etc/kubernetes/scheduler.kubeconfig Restart=always RestartSec=10s [Install] WantedBy=multi-user.target EOF # 启动 systemctl daemon-reload \u0026\u0026 systemctl enable --now kube-scheduler 确认集群组件状态\n# 所有Master节点均检查，-l参数输出完整信息 # 如果有E开头的报错，需要排查解决一下，常见问题是IP冲突、证书错误 # W告警可暂时忽略 systemctl status kube-apiserver -l systemctl status kube-controller-manager -l systemctl status kube-scheduler -l 配置TLS Bootstrapping 只需在master01节点配置，TLS Bootstrapping的官方说明请见：TLS Bootstrapping\ncd /root/k8s-ha-install/bootstrap # 查看一下secret，name后要和token-id一致，token-id.token-secret和集群设置--token=对应上 [root@k8s-master01 bootstrap]# cat bootstrap.secret.yaml apiVersion: v1 kind: Secret metadata: name: bootstrap-token-c8ad9c namespace: kube-system type: bootstrap.kubernetes.io/token stringData: description: \"The default bootstrap token generated by 'kubelet '.\" token-id: c8ad9c token-secret: 2e4d610cf3e7426e ... kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.pem --embed-certs=true --server=https://192.168.43.200:8443 --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config set-credentials tls-bootstrap-token-user --token=c8ad9c.2e4d610cf3e7426e --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config set-context tls-bootstrap-token-user@kubernetes --cluster=kubernetes --user=tls-bootstrap-token-user --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig kubectl config use-context tls-bootstrap-token-user@kubernetes --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig # 创建配置目录，拷贝admin.kubeconfig文件为config，授权kubectl，使得当前用户可以使用kubectl创建资源 # 其他master节点如果需要使用kubectl命令创建资源，也可以拷贝文件过去 # 下面是没有授权的情况 # [root@k8s-master01 bootstrap]# kubectl get cs # The connection to the server localhost:8080 was refused - did you specify the right host or port? mkdir -p /root/.kube;cp /etc/kubernetes/admin.kubeconfig /root/.kube/config # 授权后查看集群状态 [root@k8s-master01 bootstrap]# kubectl get cs Warning: v1 ComponentStatus is deprecated in v1.19+ NAME STATUS MESSAGE ERROR scheduler Healthy ok controller-manager Healthy ok etcd-0 Healthy {\"health\":\"true\",\"reason\":\"\"} etcd-1 Healthy {\"health\":\"true\",\"reason\":\"\"} etcd-2 Healthy {\"health\":\"true\",\"reason\":\"\"} # 创建bootstrap-secret [root@k8s-master01 bootstrap]# kubectl apply -f bootstrap.secret.yaml secret/bootstrap-token-c8ad9c created clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created 配置Kubelet # 从master01拷贝证书文件到其他节点 cd /etc/kubernetes/ for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do ssh $i mkdir -p /etc/kubernetes/pki for FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig; do scp /etc/kubernetes/$FILE $i:/etc/kubernetes/${FILE} done done # 所有节点配置kubelet服务 cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kubelet.service [Unit] Description=Kubernetes Kubelet Documentation=https://github.com/kubernetes/kubernetes [Service] ExecStart=/usr/local/bin/kubelet Restart=always StartLimitInterval=0 RestartSec=10 [Install] WantedBy=multi-user.target EOF # Runtime为Containerd，kubelet服务的配置文件 cat \u003c\u003c \"EOF\" \u003e /etc/systemd/system/kubelet.service.d/10-kubelet.conf [Service] Environment=\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig\" Environment=\"KUBELET_SYSTEM_ARGS=--container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock\" Environment=\"KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml\" Environment=\"KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' \" ExecStart= ExecStart=/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_SYSTEM_ARGS $KUBELET_EXTRA_ARGS EOF # 创建kubelet配置文件，对应上面Environment配置KUBELET_CONFIG_ARGS # clusterDNS配置为service网段的第十个地址 cat \u003c\u003c \"EOF\" \u003e /etc/kubernetes/kubelet-conf.yml apiVersion: kubelet.config.k8s.io/v1beta1 kind: KubeletConfiguration address: 0.0.0.0 port: 10250 readOnlyPort: 10255 authentication: anonymous: enabled: false webhook: cacheTTL: 2m0s enabled: true x509: clientCAFile: /etc/kubernetes/pki/ca.pem authorization: mode: Webhook webhook: cacheAuthorizedTTL: 5m0s cacheUnauthorizedTTL: 30s cgroupDriver: systemd cgroupsPerQOS: true clusterDNS: - 10.96.0.10 clusterDomain: cluster.local containerLogMaxFiles: 5 containerLogMaxSize: 10Mi contentType: application/vnd.kubernetes.protobuf cpuCFSQuota: true cpuManagerPolicy: none cpuManagerReconcilePeriod: 10s enableControllerAttachDetach: true enableDebuggingHandlers: true enforceNodeAllocatable: - pods eventBurst: 10 eventRecordQPS: 5 evictionHard: imagefs.available: 15% memory.available: 100Mi nodefs.available: 10% nodefs.inodesFree: 5% evictionPressureTransitionPeriod: 5m0s failSwapOn: true fileCheckFrequency: 20s hairpinMode: promiscuous-bridge healthzBindAddress: 127.0.0.1 healthzPort: 10248 httpCheckFrequency: 20s imageGCHighThresholdPercent: 85 imageGCLowThresholdPercent: 80 imageMinimumGCAge: 2m0s iptablesDropBit: 15 iptablesMasqueradeBit: 14 kubeAPIBurst: 10 kubeAPIQPS: 5 makeIPTablesUtilChains: true maxOpenFiles: 1000000 maxPods: 110 nodeStatusUpdateFrequency: 10s oomScoreAdj: -999 podPidsLimit: -1 registryBurst: 10 registryPullQPS: 5 resolvConf: /etc/resolv.conf rotateCertificates: true runtimeRequestTimeout: 2m0s serializeImagePulls: true staticPodPath: /etc/kubernetes/manifests streamingConnectionIdleTimeout: 4h0m0s syncFrequency: 1m0s volumeStatsAggPeriod: 1m0s EOF # 启动服务 systemctl daemon-reload \u0026\u0026 systemctl enable --now kubelet # 以k8s-master01为例查看运行日志和状态，只有CNI一处报错表示配置正确，后面CNI配置好后就会正常 tail -f /var/log/messages ... Apr 21 16:15:56 k8s-master01 kubelet: E0421 16:15:56.608747 7169 kubelet.go:2475] \"Container runtime network not ready\" networkReady=\"NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized\" ... [root@k8s-master01 ~]# systemctl status kubelet ● kubelet.service - Kubernetes Kubelet Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled) Drop-In: /etc/systemd/system/kubelet.service.d └─10-kubelet.conf Active: active (running) since 五 2023-04-21 16:09:00 CST; 6min ago Docs: https://github.com/kubernetes/kubernetes Main PID: 7169 (kubelet) Tasks: 11 Memory: 40.6M CGroup: /system.slice/kubelet.service └─7169 /usr/local/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kuberne... 4月 21 16:14:26 k8s-master01 kubelet[7169]: E0421 16:14:26.578931 7169 kubelet.go:2475] \"Container runtime network not read...alized\" 4月 21 16:14:31 k8s-master01 kubelet[7169]: E0421 16:14:31.580077 7169 kubelet.go:2475] \"Container runtime network not read...alized\" .... # 并且此时节点状态应该是可查询且处于NotReady，CNI配置后就会ready [root@k8s-master01 ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master01 NotReady 7m12s v1.26.4 k8s-master02 NotReady 7m11s v1.26.4 k8s-master03 NotReady 7m10s v1.26.4 k8s-node01 NotReady 7m24s v1.26.4 k8s-node02 NotReady 7m12s v1.26.4 配置Kube-proxy # 只需在k8s-master01上执行 cd /root/k8s-ha-install kubectl -n kube-system create serviceaccount kube-proxy kubectl create clusterrolebinding system:kube-proxy --clusterrole system:node-proxier --serviceaccount kube-system:kube-proxy SECRET=$(kubectl -n kube-system get sa/kube-proxy \\ --output=jsonpath='{.secrets[0].name}') JWT_TOKEN=$(kubectl -n kube-system get secret/$SECRET \\ --output=jsonpath='{.data.token}' | base64 -d) PKI_DIR=/etc/kubernetes/pki K8S_DIR=/etc/kubernetes kubectl config set-cluster kubernetes --certificate-authority=/etc/kubernetes/pki/ca.pem --embed-certs=true --server=https://192.168.43.200:8443 --kubeconfig=${K8S_DIR}/kube-proxy.kubeconfig kubectl config set-credentials kubernetes --token=${JWT_TOKEN} --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig kubectl config set-context kubernetes --cluster=kubernetes --user=kubernetes --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig kubectl config use-context kubernetes --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig # 从k8s-master01将kubeconfig拷贝到其他节点 for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do scp /etc/kubernetes/kube-proxy.kubeconfig $i:/etc/kubernetes/kube-proxy.kubeconfig done # 所有节点配置kube-proxy服务 cat \u003c\u003c \"EOF\" \u003e /usr/lib/systemd/system/kube-proxy.service [Unit] Description=Kubernetes Kube Proxy Documentation=https://github.com/kubernetes/kubernetes After=network.target [Service] ExecStart=/usr/local/bin/kube-proxy \\ --config=/etc/kubernetes/kube-proxy.yaml \\ --v=2 Restart=always RestartSec=10s [Install] WantedBy=multi-user.target EOF # 所有节点配置kube-proxy.yaml,clusterCIDR为pod网段 cat \u003c\u003c \"EOF\" \u003e /etc/kubernetes/kube-proxy.yaml apiVersion: kubeproxy.config.k8s.io/v1alpha1 bindAddress: 0.0.0.0 clientConnection: acceptContentTypes: \"\" burst: 10 contentType: application/vnd.kubernetes.protobuf kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig qps: 5 clusterCIDR: 172.16.0.0/12 configSyncPeriod: 15m0s conntrack: max: null maxPerCore: 32768 min: 131072 tcpCloseWaitTimeout: 1h0m0s tcpEstablishedTimeout: 24h0m0s enableProfiling: false healthzBindAddress: 0.0.0.0:10256 hostnameOverride: \"\" iptables: masqueradeAll: false masqueradeBit: 14 minSyncPeriod: 0s syncPeriod: 30s ipvs: masqueradeAll: true minSyncPeriod: 5s scheduler: \"rr\" syncPeriod: 30s kind: KubeProxyConfiguration metricsBindAddress: 127.0.0.1:10249 mode: \"ipvs\" nodePortAddresses: null oomScoreAdj: -999 portRange: \"\" udpIdleTimeout: 250ms EOF # 启动 systemctl daemon-reload \u0026\u0026 systemctl enable --now kube-proxy 配置Calico # k8s-master01上执行，更改calico中Pod网段为自己的 cd /root/k8s-ha-install/calico/ sed -i \"s#POD_CIDR#172.16.0.0/12#g\" calico.yaml # 检查是否更改成功 [root@k8s-master01 calico]# grep \"IPV4POOL_CIDR\" calico.yaml -A 1 - name: CALICO_IPV4POOL_CIDR value: \"172.16.0.0/12\" # 应用calico [root@k8s-master01 calico]# kubectl apply -f calico.yaml poddisruptionbudget.policy/calico-kube-controllers created poddisruptionbudget.policy/calico-typha created serviceaccount/calico-kube-controllers created serviceaccount/calico-node created configmap/calico-config created customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created clusterrole.rbac.authorization.k8s.io/calico-node created clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created clusterrolebinding.rbac.authorization.k8s.io/calico-node created service/calico-typha created daemonset.apps/calico-node created deployment.apps/calico-kube-controllers created deployment.apps/calico-typha created # （中间状态）在calico生效过程中查看各节点污点状态，发现均有不可调度污点，不必管他，等待calico生效即可，这种污点是kubernetes集群保护机制，在节点处于not ready状态时，节点不可调度 [root@k8s-master01 calico]# kubectl describe node| grep Taints: Taints: node.kubernetes.io/not-ready:NoSchedule Taints: node.kubernetes.io/not-ready:NoSchedule Taints: node.kubernetes.io/not-ready:NoSchedule Taints: node.kubernetes.io/not-ready:NoSchedule Taints: node.kubernetes.io/not-ready:NoSchedule # calico Pod处于Running后集群网络将建立，node将处于Ready状态，calico建立网络取决于电脑性能（硬件和网络环境），一般几分钟即可完成，性能差的可能会花费更长时间 [root@k8s-master01 calico]# kubectl get po -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system calico-kube-controllers-6bd6b69df9-5nwkl 1/1 Running 0 10m kube-system calico-node-8cvcd 1/1 Running 0 10m kube-system calico-node-96mx8 1/1 Running 1 (36s ago) 10m kube-system calico-node-f49rb 1/1 Running 0 10m kube-system calico-node-rgs7f 1/1 Running 0 10m kube-system calico-node-vzrls 1/1 Running 0 10m kube-system calico-typha-77fc8866f5-h9bsj 1/1 Running 0 10m # 查看集群状态和资源 [root@k8s-master01 calico]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master01 Ready 23m v1.26.4 k8s-master02 Ready 23m v1.26.4 k8s-master03 Ready 23m v1.26.4 k8s-node01 Ready 23m v1.26.4 k8s-node02 Ready 23m v1.26.4 配置CoreDNS 在k8s-master01操作 # 如果更改了k8s service的网段需要将coredns的serviceIP改成k8s service网段的第十个IP cd /root/k8s-ha-install/ COREDNS_SERVICE_IP=`kubectl get svc | grep kubernetes | awk '{print $3}'`0 sed -i \"s#KUBEDNS_SERVICE_IP#${COREDNS_SERVICE_IP}#g\" CoreDNS/coredns.yaml kubectl apply -f CoreDNS/coredns.yaml [root@k8s-master01 k8s-ha-install]# kubectl get pod -A | grep coredns kube-system coredns-5db5696c7-tsqts 1/1 Running 0 80s 配置Metrics 在k8s-master01操作 在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率。\ncd /root/k8s-ha-install/metrics-server kubectl create -f . # 等待metrics-server部署好后，便可使用 [root@k8s-master01 metrics-server]# kubectl top nodes NAME CPU(cores) CPU% MEMORY(bytes) MEMORY% k8s-master01 186m 9% 1094Mi 58% k8s-master02 192m 9% 1176Mi 62% k8s-master03 176m 8% 1123Mi 60% k8s-node01 72m 3% 463Mi 24% k8s-node02 66m 3% 472Mi 25% 配置Dashboard Dashboard是一个展示Kubernetes集群资源和Pod日志，甚至可以执行容器命令的web控制台。\n# 直接部署即可 cd /root/k8s-ha-install/dashboard/ kubectl apply -f . # 查看dashboard端口，默认是NodePort模式，访问集群内任意节点的32486端口即可 [root@k8s-master01 ~]# kubectl get svc -A | grep dash kubernetes-dashboard dashboard-metrics-scraper ClusterIP 10.111.39.8 8000/TCP 12m kubernetes-dashboard kubernetes-dashboard NodePort 10.98.143.126 443:32486/TCP 12m 访问dashboard：https://集群内任意节点IP:32486\n发现提示隐私设置错误的问题，解决方法是在Chrome浏览器启动参数加入--test-type --ignore-certificate-errors，再访问就没有这个提示\n# 获取登陆令牌（token） [root@k8s-master01 dashboard]# kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk '{print $1}') Name: admin-user-token-cj2kt Namespace: kube-system Labels: Annotations: kubernetes.io/service-account.name: admin-user kubernetes.io/service-account.uid: c86fbde2-36ea-4dd3-94fd-8ce8012fdf22 Type: kubernetes.io/service-account-token Data ==== ca.crt: 1411 bytes namespace: 11 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6ImFPeklobHBkNVRzZzZYVF9nbG5BMTgwOHdvMUNkV2FGbW1wdmUzZzdJRXcifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWNqMmt0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJjODZmYmRlMi0zNmVhLTRkZDMtOTRmZC04Y2U4MDEyZmRmMjIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.YgxIsaxR-hfyT9YLGdszggQ0Rvoc4SvyqswgvHz2ySc27q8lAQ7EJxhze3bhrdTL79z3J30T6vmuA5Be3kq_c2r42r2Iy-pC92t8xTISlPWEl7JfSg8GSbX2-UxUM_wqCmbMO3RWGYW5FpzrJ2pSVaeIGlu2JmYTugtS50LCFi87DmP2tDAKLQfh1NRylpEPI1AJPbl41E2wyDBUlS86YF_glUnQxyDCyrf2wJ2Akjqe7If2b9tAXHbSZBcQJFGHENymYhdBW6QObmTRxUsaOX9wdTToFcoHr-FaE4LcP9KuXhxP-gNNyVN7HN0k0WbhAp6CBIoypFCVLIN96EvNIg 选择ALL namespace，可以查看如下图 集群优化(可选) Docker可在/etc/docker/daemon.json自定义优化配置，所有配置可见：官方docker configuration，docker常用优化配置见下方注释说明。\n# （！！！如果使用docker作为Runtime的话）优化docker配置 # /etc/docker/daemon.json文件，按需配置，不需要全部都照抄，使用时删除注释，因为JSON文件不支持注释 { \"exec-opts\": [\"native.cgroupdriver=systemd\"], # cgroups驱动 \"registry-mirrors\": [\"https://ynirk4k5.mirror.aliyuncs.com\"], # 镜像加速器地址 \"allow-nondistributable-artifacts\": [], \"api-cors-header\": \"\", \"authorization-plugins\": [], \"bip\": \"\", \"bridge\": \"\", \"cgroup-parent\": \"\", \"cluster-advertise\": \"\", \"cluster-store\": \"\", \"cluster-store-opts\": {}, \"containerd\": \"/run/containerd/containerd.sock\", \"containerd-namespace\": \"docker\", \"data-root\": \"\", # 数据根目录，大量docker镜像可能会占用较大存储，可以设置系统盘外的挂载盘 \"debug\": true, \"default-address-pools\": [ { \"base\": \"172.30.0.0/16\", \"size\": 24 }, { \"base\": \"172.31.0.0/16\", \"size\": 24 } ], \"default-cgroupns-mode\": \"private\", \"default-gateway\": \"\", \"default-gateway-v6\": \"\", \"default-runtime\": \"runc\", \"default-shm-size\": \"64M\", \"default-ulimits\": { \"nofile\": { \"Hard\": 64000, \"Name\": \"nofile\", \"Soft\": 64000 } }, \"dns\": [], \"dns-opts\": [], \"dns-search\": [], \"exec-root\": \"\", \"experimental\": false, \"features\": {}, \"fixed-cidr\": \"\", \"fixed-cidr-v6\": \"\", \"group\": \"\", \"hosts\": [], \"icc\": false, \"init\": false, \"init-path\": \"/usr/libexec/docker-init\", \"insecure-registries\": [], \"ip\": \"0.0.0.0\", \"ip-forward\": false, \"ip-masq\": false, \"iptables\": false, \"ip6tables\": false, \"ipv6\": false, \"labels\": [], \"live-restore\": true, # docker进程宕机时容器依然保持存活 \"log-driver\": \"json-file\", # 日志格式 \"log-level\": \"\", # 日志级别 \"log-opts\": { # 日志优化 \"cache-disabled\": \"false\", \"cache-max-file\": \"5\", \"cache-max-size\": \"20m\", \"cache-compress\": \"true\", \"env\": \"os,customer\", \"labels\": \"somelabel\", \"max-file\": \"5\", # 最大日志数量 \"max-size\": \"10m\" # 保存的最大日志大小 }, \"max-concurrent-downloads\": 3, # pull下载并发数 \"max-concurrent-uploads\": 5, # push上传并发数 \"max-download-attempts\": 5, \"mtu\": 0, \"no-new-privileges\": false, \"node-generic-resources\": [ \"NVIDIA-GPU=UUID1\", \"NVIDIA-GPU=UUID2\" ], \"oom-score-adjust\": -500, \"pidfile\": \"\", \"raw-logs\": false, \"runtimes\": { \"cc-runtime\": { \"path\": \"/usr/bin/cc-runtime\" }, \"custom\": { \"path\": \"/usr/local/bin/my-runc-replacement\", \"runtimeArgs\": [ \"--debug\" ] } }, \"seccomp-profile\": \"\", \"selinux-enabled\": false, \"shutdown-timeout\": 15, \"storage-driver\": \"\", \"storage-opts\": [], \"swarm-default-advertise-addr\": \"\", \"tls\": true, \"tlscacert\": \"\", \"tlscert\": \"\", \"tlskey\": \"\", \"tlsverify\": true, \"userland-proxy\": false, \"userland-proxy-path\": \"/usr/libexec/docker-proxy\", \"userns-remap\": \"\" } # 无注释版 { \"exec-opts\": [\"native.cgroupdriver=systemd\"], \"registry-mirrors\": [\"https://ynirk4k5.mirror.aliyuncs.com\"], \"containerd-namespace\": \"docker\", \"data-root\": \"\", \"debug\": true, \"default-cgroupns-mode\": \"private\", \"default-gateway\": \"\", \"default-gateway-v6\": \"\", \"default-runtime\": \"runc\", \"default-shm-size\": \"64M\", \"default-ulimits\": { \"nofile\": { \"Hard\": 64000, \"Name\": \"nofile\", \"Soft\": 64000 } }, \"init-path\": \"/usr/libexec/docker-init\", \"live-restore\": true, \"log-driver\": \"json-file\", \"log-level\": \"\", \"log-opts\": { \"cache-disabled\": \"false\", \"cache-max-file\": \"5\", \"cache-max-size\": \"20m\", \"cache-compress\": \"true\", \"env\": \"os,customer\", \"labels\": \"somelabel\", \"max-file\": \"5\", \"max-size\": \"10m\" }, \"max-concurrent-downloads\": 3, \"max-concurrent-uploads\": 5, \"max-download-attempts\": 5, \"mtu\": 0, \"no-new-privileges\": false, \"oom-score-adjust\": -500, \"pidfile\": \"\", \"raw-logs\": false, \"runtimes\": { \"cc-runtime\": { \"path\": \"/usr/bin/cc-runtime\" }, \"custom\": { \"path\": \"/usr/local/bin/my-runc-replacement\", \"runtimeArgs\": [ \"--debug\" ] } }, \"seccomp-profile\": \"\", \"selinux-enabled\": false, \"shutdown-timeout\": 15, \"storage-driver\": \"\", \"storage-opts\": [], \"swarm-default-advertise-addr\": \"\", \"userland-proxy-path\": \"/usr/libexec/docker-proxy\", \"userns-remap\": \"\" } # 设置证书有效期 [root@k8s-master01 ~]# vim /usr/lib/systemd/system/kube-controller-manager.service ... # 加入下面配置 --experimental-cluster-signing-duration=876000h0m0s ... [root@k8s-master01 ~]# systemctl daemon-reload [root@k8s-master01 ~]# systemctl restart kube-controller-manager # kubelet优化加密算法，默认的算法容易被漏洞扫描；增长镜像下载周期，避免有些大镜像未下载完成就被动死亡退出 # --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 # --image-pull-progress-deadline=30m [root@k8s-master01 ~]# vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf ... # 下面这行中KUBELET_EXTRA_ARGS=后加入配置 Environment=\"KUBELET_EXTRA_ARGS=--tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 --image-pull-progress-deadline=30m\" ... # 集群配置优化，详见https://kubernetes.io/zh/docs/tasks/administer-cluster/reserve-compute-resources/ [root@k8s-master01 ~]# vim /etc/kubernetes/kubelet-conf.yml # 文件中添加如下配置 rotateServerCertificates: true allowedUnsafeSysctls: # 允许在修改内核参数，此操作按情况选择，用不到就不用设置 - \"net.core*\" - \"net.ipv4.*\" kubeReserved: # 为Kubernetes集群守护进程组件预留资源，例如：kubelet、Runtime等 cpu: \"100m\" memory: 100Mi ephemeral-storage: 1Gi systemReserved: # 为系统守护进程预留资源，例如：sshd、cron等 cpu: \"100m\" memory: 100Mi ephemeral-storage: 1Gi # 为集群节点打标签，删除标签把 = 换成 - 即可 kubectl label nodes k8s-node01 node-role.kubernetes.io/node= kubectl label nodes k8s-node02 node-role.kubernetes.io/node= kubectl label nodes k8s-master01 node-role.kubernetes.io/master= kubectl label nodes k8s-master02 node-role.kubernetes.io/master= kubectl label nodes k8s-master03 node-role.kubernetes.io/master= # 添加标签后查看集群状态 [root@k8s-master01 ~]# kubectl get node NAME STATUS ROLES AGE VERSION k8s-master01 Ready master 35m v1.26.4 k8s-master02 Ready master 35m v1.26.4 k8s-master03 Ready master 35m v1.26.4 k8s-node01 Ready node 35m v1.26.4 k8s-node02 Ready node 35m v1.26.4 生产环境建议ETCD集群和Kubernetes集群分离，而且使用高性能数据盘存储数据，根据情况决定是否将Master节点也作为Pod调度节点。\n测试集群 # 测试namespace kubectl get namespace kubectl create namespace test kubectl get namespace kubectl delete namespace test # 创建nginx实例并开放端口 kubectl create deployment nginx --image=nginx kubectl expose deployment nginx --port=80 --type=NodePort # 查看调度状态和端口号 [root@k8s-master01 ~]# kubectl get po,svc -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES pod/nginx-748c667d99-dmtn6 1/1 Running 0 9m55s 172.25.244.194 k8s-master01 NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE SELECTOR service/kubernetes ClusterIP 10.96.0.1 443/TCP 69m service/nginx NodePort 10.110.18.105 80:31687/TCP 9s app=nginx 在浏览器输入http://任意节点IP:31687/ 访问nginx，访问结果如图\n至此，基于二进制方式的Kubernetes高可用集群部署并验证成功。\n",
  "wordCount" : "10865",
  "inLanguage": "en",
  "image":"https://deemoprobe.github.io/img/kubernetes.png","datePublished": "2023-04-29T14:17:51+08:00",
  "dateModified": "2023-04-29T14:17:51+08:00",
  "author":[{
    "@type": "Person",
    "name": "deemoprobe"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://deemoprobe.github.io/posts/tech/kubernetes/kubernetesbinaryinstallation-ha/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "William's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://deemoprobe.github.io/img/favicon/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://deemoprobe.github.io/" accesskey="h" title="William&#39;s Blog (Alt + H)">
            <img src="https://deemoprobe.github.io/img/favicon/favicon-32x32.png" alt="logo" aria-label="logo"
                 height="32">William&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://deemoprobe.github.io/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tags" title="🎨 标签">
                <span>🎨 标签</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/archives/" title="📈 归档">
                <span>📈 归档</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/tools" title="🪁 工具">
                <span>🪁 工具</span>
                </a>
            </li>
            <li>
                <a href="https://deemoprobe.github.io/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            
            <h1 class="post-title">
                KubernetesBinaryInstallation HA
            </h1>
            <div class="post-description">
                二进制方式部署kubernetes高可用集群
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2023-04-29
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>10865字
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>22分钟
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>deemoprobe
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://deemoprobe.github.io/tags/kubernetes/" style="color: var(--secondary)!important;">kubernetes</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    
                </span>

</div>
        </header> 
<figure class="entry-cover1"><img style="zoom:;" loading="lazy" src="https://deemoprobe.github.io/img/kubernetes.png" alt="">
    
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">文章目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e7%8e%af%e5%a2%83%e8%af%b4%e6%98%8e" aria-label="环境说明">环境说明</a></li>
                <li>
                    <a href="#%e8%b5%84%e6%ba%90%e5%88%86%e9%85%8d" aria-label="资源分配">资源分配</a></li>
                <li>
                    <a href="#%e6%93%8d%e4%bd%9c%e6%ad%a5%e9%aa%a4" aria-label="操作步骤">操作步骤</a><ul>
                        
                <li>
                    <a href="#%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9call" aria-label="准备工作(ALL)">准备工作(ALL)</a></li>
                <li>
                    <a href="#%e9%83%a8%e7%bd%b2containerdall" aria-label="部署Containerd(ALL)">部署Containerd(ALL)</a></li>
                <li>
                    <a href="#%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%8c%85%e5%92%8c%e8%af%81%e4%b9%a6" aria-label="二进制包和证书">二进制包和证书</a></li>
                <li>
                    <a href="#etcd%e9%9b%86%e7%be%a4master" aria-label="ETCD集群(Master)">ETCD集群(Master)</a></li>
                <li>
                    <a href="#%e9%ab%98%e5%8f%af%e7%94%a8%e7%bb%84%e4%bb%b6master" aria-label="高可用组件(Master)">高可用组件(Master)</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%ae%e9%9b%86%e7%be%a4%e7%bb%84%e4%bb%b6" aria-label="配置集群组件">配置集群组件</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aetls-bootstrapping" aria-label="配置TLS Bootstrapping">配置TLS Bootstrapping</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aekubelet" aria-label="配置Kubelet">配置Kubelet</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aekube-proxy" aria-label="配置Kube-proxy">配置Kube-proxy</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aecalico" aria-label="配置Calico">配置Calico</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aecoredns" aria-label="配置CoreDNS">配置CoreDNS</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aemetrics" aria-label="配置Metrics">配置Metrics</a></li>
                <li>
                    <a href="#%e9%85%8d%e7%bd%aedashboard" aria-label="配置Dashboard">配置Dashboard</a></li>
                <li>
                    <a href="#%e9%9b%86%e7%be%a4%e4%bc%98%e5%8c%96%e5%8f%af%e9%80%89" aria-label="集群优化(可选)">集群优化(可选)</a></li>
                <li>
                    <a href="#%e6%b5%8b%e8%af%95%e9%9b%86%e7%be%a4" aria-label="测试集群">测试集群</a>
                </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h2 id="环境说明">环境说明<a hidden class="anchor" aria-hidden="true" href="#环境说明">#</a></h2>
<ul>
<li>宿主机系统：Windows 10</li>
<li>虚拟机版本：VMware® Workstation 16 Pro</li>
<li>IOS镜像版本：CentOS Linux release 7.9.2009</li>
<li>Kubernetes版本：1.26.4</li>
<li>Runtime：Containerd v1.6.20</li>
<li>Etcd版本：3.5.6</li>
<li>集群操作用户：root</li>
<li>更新时间：2023-04-21</li>
</ul>
<p>CentOS7安装请参考博客文章：<a href="https://www.deemo.dev/linux/centos7install/"  target="_blank" rel="noopener" style="color:#42b983" ;>LINUX之VMWARE WORKSTATION安装CENTOS-7</a></p>
<h2 id="资源分配">资源分配<a hidden class="anchor" aria-hidden="true" href="#资源分配">#</a></h2>
<p><strong>网段划分</strong></p>
<p>Kubernetes集群需要规划三个网段：</p>
<ul>
<li>宿主机网段：Kubernetes集群节点的网段</li>
<li>Pod网段：集群内Pod的网段，相当于容器的IP</li>
<li>Service网段：集群内服务发现使用的网段，service用于集群容器通信</li>
</ul>
<p>生产环境根据申请到的IP资源进行分配即可，原则是三个网段不允许有重合IP。IP网段计算可以参考：<a href="http://tools.jb51.net/aideddesign/ip_net_calc/"  target="_blank" rel="noopener" style="color:#42b983" ;>在线IP地址计算</a>。本文虚拟机练习环境IP地址网段分配如下：</p>
<ul>
<li>宿主机网段：<code>192.168.43.1/24</code></li>
<li>Pod网段：<code>172.16.0.0/12</code></li>
<li>Service：<code>10.96.0.0/12</code></li>
</ul>
<p><strong>节点分配</strong></p>
<p>采用<code>3管理节点2工作节点</code>的高可用Kubernetes集群模式：</p>
<ul>
<li>k8s-master01/k8s-master02/k8s-master03 集群的Master节点</li>
<li>三个master节点同时做etcd集群</li>
<li>k8s-node01/k8s-node02 集群的Node节点</li>
<li>k8s-master-vip做高可用k8s-master01~03的VIP，不占用物理资源</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">主机节点名称</th>
<th style="text-align:center">IP</th>
<th style="text-align:center">CPU核心数</th>
<th style="text-align:center">内存大小</th>
<th style="text-align:center">磁盘大小</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">k8s-master-vip</td>
<td style="text-align:center">192.168.43.200</td>
<td style="text-align:center">/</td>
<td style="text-align:center">/</td>
<td style="text-align:center">/</td>
</tr>
<tr>
<td style="text-align:left">k8s-master01</td>
<td style="text-align:center">192.168.43.201</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-master02</td>
<td style="text-align:center">192.168.43.202</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-master03</td>
<td style="text-align:center">192.168.43.203</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-node01</td>
<td style="text-align:center">192.168.43.204</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
<tr>
<td style="text-align:left">k8s-node02</td>
<td style="text-align:center">192.168.43.205</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2G</td>
<td style="text-align:center">40G</td>
</tr>
</tbody>
</table>
<h2 id="操作步骤">操作步骤<a hidden class="anchor" aria-hidden="true" href="#操作步骤">#</a></h2>
<p>标题后小括号注释表明操作范围：</p>
<ul>
<li>ALL 所有节点（k8s-master01/k8s-master02/k8s-master03/k8s-node01/k9s-node02）执行</li>
<li>Master 只需要在master节点（k8s-master01/k8s-master02/k8s-master03）执行</li>
<li>Node 只需要在node节点（k8s-node01/k8s-node02）执行</li>
<li>已标注的个别命令只需要在某一台机器执行，会在操作前说明</li>
<li>未标注的会在操作时说明</li>
</ul>
<p>使用<code>cat &lt;&lt; &quot;EOF&quot; &gt;&gt; file</code>或<code>cat &gt;&gt; file &lt;&lt; &quot;EOF&quot;</code>添加文件内容注意cat后面的EOF一定要加上双引号（标准输入的），否则不会保留输入时的缩进格式而且会直接解析输入时的变量，进而造成文件可读性差甚至不可用；同时注意文件的<code>&gt;</code>重写与<code>&gt;&gt;</code>追加。虽然单独转义输入时的变量也能避免变量被解析，但是不推荐，漏转义会造成不必要的麻烦。</p>
<h3 id="准备工作all">准备工作(ALL)<a hidden class="anchor" aria-hidden="true" href="#准备工作all">#</a></h3>
<p>添加主机信息、关闭防火墙、关闭swap、关闭SELinux、dnsmasq、NetworkManager</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 添加主机信息</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt;&gt; /etc/hosts
</span></span><span style="display:flex;"><span>192.168.43.200    k8s-master-vip
</span></span><span style="display:flex;"><span>192.168.43.201    k8s-master01
</span></span><span style="display:flex;"><span>192.168.43.202    k8s-master02
</span></span><span style="display:flex;"><span>192.168.43.203    k8s-master03
</span></span><span style="display:flex;"><span>192.168.43.204    k8s-node01
</span></span><span style="display:flex;"><span>192.168.43.205    k8s-node02
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关闭防火墙、dnsmasq、NetworkManager，--now参数表示关闭服务并移除开机自启</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这些服务是否可以关闭视情况而定，本文是虚拟机实践，没有用到这些服务</span>
</span></span><span style="display:flex;"><span>systemctl disable --now firewalld
</span></span><span style="display:flex;"><span>systemctl disable --now dnsmasq
</span></span><span style="display:flex;"><span>systemctl disable --now NetworkManager
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关闭swap，并注释fstab文件swap所在行</span>
</span></span><span style="display:flex;"><span>swapoff -a
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;/swap/s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 关闭SELinux，并更改selinux配置文件</span>
</span></span><span style="display:flex;"><span>setenforce <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s/=enforcing/=disabled/g&#34;</span> /etc/selinux/config
</span></span></code></pre></div><p>值得注意的是<code>/etc/sysconfig/selinux</code>文件是<code>/etc/selinux/config</code>文件的软连接，用<code>sed -i</code>命令修改软连接文件会破坏软连接属性，将<code>/etc/sysconfig/selinux</code>变为一个独立的文件，即使该文件被修改了，但源文件<code>/etc/selinux/config</code>配置是没变的。此外，使用vim等编辑器编辑源文件或链接文件（编辑模式不会修改文件属性）修改也可以。软链接原理可参考博客：<a href="http://www.deemoprobe.com/yunv/inode/"  target="_blank" rel="noopener" style="color:#42b983" ;>LINUX之INODE详解</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 默认的yum源太慢，更新为阿里源，同时用sed命令删除文件中不需要的两个URL的行</span>
</span></span><span style="display:flex;"><span>curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
</span></span><span style="display:flex;"><span>sed -i -e <span style="color:#e6db74">&#39;/mirrors.cloud.aliyuncs.com/d&#39;</span> -e <span style="color:#e6db74">&#39;/mirrors.aliyuncs.com/d&#39;</span> /etc/yum.repos.d/CentOS-Base.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装常用工具包</span>
</span></span><span style="display:flex;"><span>yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置ntpdate，同步服务器时间</span>
</span></span><span style="display:flex;"><span>rpm -ivh http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm
</span></span><span style="display:flex;"><span>yum install ntpdate -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 同步时区和时间</span>
</span></span><span style="display:flex;"><span>ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;Asia/Shanghai&#39;</span> &gt;/etc/timezone
</span></span><span style="display:flex;"><span>ntpdate time2.aliyun.com
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 可以加入计划任务，保证集群时钟是一致的</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /var/spool/cron/root文件也是crontab -e写入的文件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># crontab执行日志查看可用：tail -f /var/log/cron</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt;&gt; /var/spool/cron/root
</span></span><span style="display:flex;"><span>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 须知：如果设置了定时任务，会经常收到提示“You have new mail in /var/spool/mail/root”</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># （可选）禁用提示：echo &#34;unset MAILCHECK&#34; &gt;&gt; ~/.bashrc;source ~/.bashrc</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 禁用提示后/var/spool/mail/root文件依旧会记录root操作日志，可随时查看</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 保证文件句柄不会限制集群的可持续发展，配置limits</span>
</span></span><span style="display:flex;"><span>ulimit -SHn <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt;&gt; /etc/security/limits.conf
</span></span><span style="display:flex;"><span>* soft nofile <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* hard nofile <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* soft nproc <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* hard nproc <span style="color:#ae81ff">65500</span>
</span></span><span style="display:flex;"><span>* soft memlock unlimited
</span></span><span style="display:flex;"><span>* hard memlock unlimited
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置免密登录，k8s-master01到其他节点</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成密钥对（在k8s-master01节点配置即可）</span>
</span></span><span style="display:flex;"><span>ssh-keygen -t rsa
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拷贝公钥到其他节点，首次需要认证一下各个节点的root密码，以后就可以免密ssh到其他节点</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span style="color:#66d9ef">do</span> ssh-copy-id -i .ssh/id_rsa.pub $i;<span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 克隆二进制仓库1.26分支的文件（k8s-master01上操作即可）</span>
</span></span><span style="display:flex;"><span>cd /root;git clone https://gitee.com/deemoprobe/k8s-ha-install.git -b manual-installation-v1.26.x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有节点系统升级</span>
</span></span><span style="display:flex;"><span>yum update --exclude<span style="color:#f92672">=</span>kernel* -y
</span></span></code></pre></div><p>升级内核，4.17以下的内核cgroup存在内存泄漏的BUG，具体分析过程浏览器搜<code>Kubernetes集群为什么要升级内核</code>会有很多文章讲解</p>
<p>内核备用下载（下载到本地后上传到服务器，尽量不要用<code>wget</code>）：</p>
<ul>
<li><a href="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/repo/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm?versionId=CAEQNBiBgMDJiNbj.hciIDUyMDZlYjU5YzIwMzQ0MmNhNzBmNjBiMDY3Yjc0Y2Jl"  target="_blank" rel="noopener" style="color:#42b983" ;>kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm</a></li>
<li><a href="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/repo/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm?versionId=CAEQNBiBgMDNiNbj.hciIGQ0M2RmZDAwNDhlNjQyNjE5MTE4MDk1OGU4OThiNWY4"  target="_blank" rel="noopener" style="color:#42b983" ;>kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 下载4.19版本内核，如果无法下载，可以用上面提供的备用下载</span>
</span></span><span style="display:flex;"><span>cd /root
</span></span><span style="display:flex;"><span>wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm
</span></span><span style="display:flex;"><span>wget http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 可以在k8s-master01节点下载后，免密传到其他节点</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span style="color:#66d9ef">do</span> scp kernel-ml-* $i:/root;<span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有节点安装内核</span>
</span></span><span style="display:flex;"><span>cd /root <span style="color:#f92672">&amp;&amp;</span> yum localinstall -y kernel-ml*
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有节点更改内核启动顺序</span>
</span></span><span style="display:flex;"><span>grub2-set-default  <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> grub2-mkconfig -o /etc/grub2.cfg
</span></span><span style="display:flex;"><span>grubby --args<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;user_namespace.enable=1&#34;</span> --update-kernel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>grubby --default-kernel<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看默认内核，并重启节点</span>
</span></span><span style="display:flex;"><span>grubby --default-kernel
</span></span><span style="display:flex;"><span>reboot
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 确认内核版本</span>
</span></span><span style="display:flex;"><span>uname -a
</span></span><span style="display:flex;"><span><span style="color:#75715e"># （可选）删除老版本的内核，避免以后被升级取代默认的开机4.19内核</span>
</span></span><span style="display:flex;"><span>rpm -qa | grep kernel
</span></span><span style="display:flex;"><span>yum remove -y kernel-3*
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 升级系统软件包（如果跳过内核升级加参数 --exclude=kernel*）</span>
</span></span><span style="display:flex;"><span>yum update -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装IPVS相关工具，由于IPVS在资源消耗和性能上均已明显优于iptables，所以推荐开启</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 具体原因可参考官网介绍 https://kubernetes.io/zh/blog/2018/07/09/ipvs-based-in-cluster-load-balancing-deep-dive/</span>
</span></span><span style="display:flex;"><span>yum install ipvsadm ipset sysstat conntrack libseccomp -y
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加载模块，最后一条4.18及以下内核使用nf_conntrack_ipv4，4.19已改为nf_conntrack</span>
</span></span><span style="display:flex;"><span>modprobe -- ip_vs
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_rr
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_wrr
</span></span><span style="display:flex;"><span>modprobe -- ip_vs_sh
</span></span><span style="display:flex;"><span>modprobe -- nf_conntrack
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编写参数文件</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/modules-load.d/ipvs.conf 
</span></span><span style="display:flex;"><span>ip_vs
</span></span><span style="display:flex;"><span>ip_vs_lc
</span></span><span style="display:flex;"><span>ip_vs_wlc
</span></span><span style="display:flex;"><span>ip_vs_rr
</span></span><span style="display:flex;"><span>ip_vs_wrr
</span></span><span style="display:flex;"><span>ip_vs_lblc
</span></span><span style="display:flex;"><span>ip_vs_lblcr
</span></span><span style="display:flex;"><span>ip_vs_dh
</span></span><span style="display:flex;"><span>ip_vs_sh
</span></span><span style="display:flex;"><span>ip_vs_fo
</span></span><span style="display:flex;"><span>ip_vs_nq
</span></span><span style="display:flex;"><span>ip_vs_sed
</span></span><span style="display:flex;"><span>ip_vs_ftp
</span></span><span style="display:flex;"><span>ip_vs_sh
</span></span><span style="display:flex;"><span>nf_conntrack
</span></span><span style="display:flex;"><span>ip_tables
</span></span><span style="display:flex;"><span>ip_set
</span></span><span style="display:flex;"><span>xt_set
</span></span><span style="display:flex;"><span>ipt_set
</span></span><span style="display:flex;"><span>ipt_rpfilter
</span></span><span style="display:flex;"><span>ipt_REJECT
</span></span><span style="display:flex;"><span>ipip
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># systemd-modules-load加入开机自启</span>
</span></span><span style="display:flex;"><span>systemctl enable --now systemd-modules-load
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 自定义内核参数优化配置文件</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/sysctl.d/kubernetes.conf
</span></span><span style="display:flex;"><span>net.ipv4.ip_forward <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-iptables <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-ip6tables <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>fs.may_detach_mounts <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.conf.all.route_localnet <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>vm.overcommit_memory<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>vm.panic_on_oom<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>fs.inotify.max_user_watches<span style="color:#f92672">=</span><span style="color:#ae81ff">89100</span>
</span></span><span style="display:flex;"><span>fs.file-max<span style="color:#f92672">=</span><span style="color:#ae81ff">52706963</span>
</span></span><span style="display:flex;"><span>fs.nr_open<span style="color:#f92672">=</span><span style="color:#ae81ff">52706963</span>
</span></span><span style="display:flex;"><span>net.netfilter.nf_conntrack_max<span style="color:#f92672">=</span><span style="color:#ae81ff">2310720</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_keepalive_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">600</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_keepalive_probes <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_keepalive_intvl <span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_tw_buckets <span style="color:#f92672">=</span> <span style="color:#ae81ff">36000</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_tw_reuse <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_orphans <span style="color:#f92672">=</span> <span style="color:#ae81ff">327680</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_orphan_retries <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_syncookies <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_syn_backlog <span style="color:#f92672">=</span> <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>net.ipv4.ip_conntrack_max <span style="color:#f92672">=</span> <span style="color:#ae81ff">65536</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_max_syn_backlog <span style="color:#f92672">=</span> <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>net.ipv4.tcp_timestamps <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>net.core.somaxconn <span style="color:#f92672">=</span> <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加载</span>
</span></span><span style="display:flex;"><span>sysctl --system
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 重启查看IPVS模块是否依旧加载</span>
</span></span><span style="display:flex;"><span>reboot
</span></span><span style="display:flex;"><span>lsmod | grep -e ip_vs -e nf_conntrack
</span></span></code></pre></div><ul>
<li>保证每台服务器中IPVS加载成功，以k8s-master01为例，如图：</li>
</ul>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20220305153926.png" alt="20220305153926"  />
</p>
<h3 id="部署containerdall">部署Containerd(ALL)<a hidden class="anchor" aria-hidden="true" href="#部署containerdall">#</a></h3>
<p>Kubernetes1.24版本以后将不再支持Docker作为Runtime，本文安装使用Containerd作为Runtime。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 配置阿里docker源</span>
</span></span><span style="display:flex;"><span>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装最新版本docker和containerd.io，安装docker是为了使用docker CLI</span>
</span></span><span style="display:flex;"><span>yum install docker-ce docker-ce-cli containerd.io -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># （可选）也可以按需安装指定版本</span>
</span></span><span style="display:flex;"><span>yum install docker-ce-20.10.* docker-ce-cli-20.10.* containerd -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置Containerd模块</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/modules-load.d/containerd.conf
</span></span><span style="display:flex;"><span>overlay
</span></span><span style="display:flex;"><span>br_netfilter
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加载模块</span>
</span></span><span style="display:flex;"><span>modprobe -- overlay
</span></span><span style="display:flex;"><span>modprobe -- br_netfilter
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置内核参数</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/sysctl.d/containerd.conf
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-iptables  <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.ipv4.ip_forward                 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net.bridge.bridge-nf-call-ip6tables <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 加载内核参数</span>
</span></span><span style="display:flex;"><span>sysctl --system
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成默认配置文件</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/containerd
</span></span><span style="display:flex;"><span>containerd config default | tee /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 更改Cgroup为Systemd，在containerd.runtimes.runc.options行后的SystemdCgroup = false修改为true，如果配置项不存在就自行添加，缩进俩空格添加SystemdCgroup = true一行</span>
</span></span><span style="display:flex;"><span>vim /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>          ...
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">[</span>plugins.<span style="color:#e6db74">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc.options<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            SystemdCgroup <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>          ...
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将sandbox_image的Pause镜像地址改成国内：registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7</span>
</span></span><span style="display:flex;"><span>vim /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>    sandbox_image <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.7&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># （可选）也可以在k8s-master01编辑/etc/containerd/config.toml文件后，将编辑后同名文件同步到其他服务器，自动覆盖</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;<span style="color:#66d9ef">do</span> scp /etc/containerd/config.toml $i:/etc/containerd/config.toml;<span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看确认是否配置成功</span>
</span></span><span style="display:flex;"><span>cat /etc/containerd/config.toml | grep -e Systemd -e sandbox_image
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动并加入开机自启</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl enable --now containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># containerd运行时的CLI是ctr</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ctr images ls</span>
</span></span><span style="display:flex;"><span>REF TYPE DIGEST SIZE PLATFORMS LABELS 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ctr version</span>
</span></span><span style="display:flex;"><span>Client:
</span></span><span style="display:flex;"><span>  Version:  1.6.20
</span></span><span style="display:flex;"><span>  Revision: 2806fc1057397dbaeefbea0e4e17bddfbd388f38
</span></span><span style="display:flex;"><span>  Go version: go1.19.7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Server:
</span></span><span style="display:flex;"><span>  Version:  1.6.20
</span></span><span style="display:flex;"><span>  Revision: 2806fc1057397dbaeefbea0e4e17bddfbd388f38
</span></span><span style="display:flex;"><span>  UUID: 9958928e-300c-4778-b83c-6c0073414f3e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置crictl连接的运行时socket接口（指向containerd&#39;s GRPC server：/run/containerd/containerd.sock）</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># crictl 默认连接到unix:///var/run/dockershim.sock</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/crictl.yaml 
</span></span><span style="display:flex;"><span>runtime-endpoint: unix:///run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>image-endpoint: unix:///run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>timeout: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>debug: false
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># crictl按需选择，https://github.com/kubernetes-sigs/cri-tools/releases</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># containerd容器管理CLI是crictl，该命令使用和docker命令类似，下载包上传到k8s-master01</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># tar -zxvf crictl-v1.27.0-linux-amd64.tar.gz</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># mv crictl /usr/local/bin/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># crictl version</span>
</span></span><span style="display:flex;"><span>Version:  0.1.0
</span></span><span style="display:flex;"><span>RuntimeName:  containerd
</span></span><span style="display:flex;"><span>RuntimeVersion:  1.6.20
</span></span><span style="display:flex;"><span>RuntimeApiVersion:  v1
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 二进制可执行文件发送到其他节点</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># for i in k8s-master02 k8s-master03 k8s-node01 k8s-node02;do scp /usr/local/bin/crictl $i:/usr/local/bin/;done</span>
</span></span></code></pre></div><blockquote>
<p>crictl 是CRI（Container Runtime Interface）兼容的容器运行时的CLI（Command-Line Interface）。可以这个命令来检查和调试 Kubernetes 节点上的容器运行时和应用程序。介绍和安装方式可见：<a href="https://github.com/kubernetes-sigs/cri-tools"  target="_blank" rel="noopener" style="color:#42b983" ;>critools</a>或<a href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/crictl/"  target="_blank" rel="noopener" style="color:#42b983" ;>Kubernetes官方介绍</a></p>
</blockquote>
<h3 id="二进制包和证书">二进制包和证书<a hidden class="anchor" aria-hidden="true" href="#二进制包和证书">#</a></h3>
<p>k8s-master01节点上下载并安装Kubernetes二进制安装包（server-binaries，选择对应的架构即可）和ETCD二进制安装包，可在GitHub上查看Kubernetes1.23.x版本的信息，<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.23.md"  target="_blank" rel="noopener" style="color:#42b983" ;>官方GitHub-Kubernetes1.23版本链接</a>，<a href="https://github.com/etcd-io/etcd/releases"  target="_blank" rel="noopener" style="color:#42b983" ;>ETCD官方链接</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 以下在k8s-master01执行</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下载太慢的话可以在相应链接网页上下载好传到服务器</span>
</span></span><span style="display:flex;"><span>wget https://dl.k8s.io/v1.26.4/kubernetes-server-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>wget https://github.com/etcd-io/etcd/releases/download/v3.5.6/etcd-v3.5.6-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解压安装，--strip-components=N表示解压时忽略解压后的N层目录，直接获取N层目录后的目标文件。kubernetes/server/bin/是三层，etcd-v3.5.6-linux-amd64/是一层</span>
</span></span><span style="display:flex;"><span>tar -zxvf kubernetes-server-linux-amd64.tar.gz --strip-components<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> -C /usr/local/bin kubernetes/server/bin/kube<span style="color:#f92672">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>tar -zxvf etcd-v3.5.6-linux-amd64.tar.gz --strip-components<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -C /usr/local/bin etcd-v3.5.6-linux-amd64/etcd<span style="color:#f92672">{</span>,ctl<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 确认版本</span>
</span></span><span style="display:flex;"><span>kubectl version
</span></span><span style="display:flex;"><span>kubelet --version
</span></span><span style="display:flex;"><span>etcdctl version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拷贝组件到其他节点，Node节点只需要kubelet和kube-proxy</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03; <span style="color:#66d9ef">do</span> scp /usr/local/bin/kube<span style="color:#f92672">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span style="color:#f92672">}</span> $i:/usr/local/bin/; scp /usr/local/bin/etcd* $i:/usr/local/bin/; <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-node01 k8s-node02; <span style="color:#66d9ef">do</span> scp /usr/local/bin/kube<span style="color:#f92672">{</span>let,-proxy<span style="color:#f92672">}</span> $i:/usr/local/bin/; <span style="color:#66d9ef">done</span>
</span></span></code></pre></div><ul>
<li>配置证书</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># master节点创建etcd证书目录</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/etcd/ssl
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有节点创建pki证书目录和CNI目录（后面calico使用）</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>mkdir -p /opt/cni/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 以下在k8s-master01操作</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装证书生成工具，如果速度慢可以浏览器下载后上传至服务器改名即可</span>
</span></span><span style="display:flex;"><span>wget <span style="color:#e6db74">&#34;https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&#34;</span> -O /usr/local/bin/cfssl
</span></span><span style="display:flex;"><span>wget <span style="color:#e6db74">&#34;https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&#34;</span> -O /usr/local/bin/cfssljson
</span></span><span style="display:flex;"><span>chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在master01节点生成etcd证书</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install/pki
</span></span><span style="display:flex;"><span>cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca
</span></span><span style="display:flex;"><span>cfssl gencert <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca-key<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -config<span style="color:#f92672">=</span>ca-config.json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -hostname<span style="color:#f92672">=</span>127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.43.201,192.168.43.202,192.168.43.203 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -profile<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 复制etcd证书到其他master节点</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> FILE in etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      scp /etc/etcd/ssl/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span> $i:/etc/etcd/ssl/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成Kubernetes集群ca证书</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install/pki
</span></span><span style="display:flex;"><span>cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s service网段10.96.0.0/12，填入网段第一个IP；集群VIP地址192.168.43.200</span>
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem -ca-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -hostname<span style="color:#f92672">=</span>10.96.0.1,192.168.43.200,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.43.201,192.168.43.202,192.168.43.203 -profile<span style="color:#f92672">=</span>kubernetes apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成apiserver的第三方组件使用的聚合证书，告警可以忽略</span>
</span></span><span style="display:flex;"><span>cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca 
</span></span><span style="display:flex;"><span>cfssl gencert -ca<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca.pem -ca-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem -config<span style="color:#f92672">=</span>ca-config.json -profile<span style="color:#f92672">=</span>kubernetes front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成controller-manager证书</span>
</span></span><span style="display:flex;"><span>cfssl gencert <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -config<span style="color:#f92672">=</span>ca-config.json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -profile<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置集群信息，集群名：kubernetes  server：https://192.168.43.200:8443</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果不是高可用集群，192.168.43.200:8443改为master01的地址，8443改为apiserver的端口，默认是6443</span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --server<span style="color:#f92672">=</span>https://192.168.43.200:8443 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置上下文信息，context为system:kube-controller-manager@kubernetes</span>
</span></span><span style="display:flex;"><span>kubectl config set-context system:kube-controller-manager@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --user<span style="color:#f92672">=</span>system:kube-controller-manager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置用户认证信息，用户为system:kube-controller-manager</span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials system:kube-controller-manager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/controller-manager.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置默认集群环境</span>
</span></span><span style="display:flex;"><span>kubectl config use-context system:kube-controller-manager@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/controller-manager.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成scheduler证书</span>
</span></span><span style="display:flex;"><span>cfssl gencert <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -config<span style="color:#f92672">=</span>ca-config.json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -profile<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 同样的，scheduler需要和controller-manager设置相同的集群上下文等信息</span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --server<span style="color:#f92672">=</span>https://192.168.43.200:8443 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials system:kube-scheduler <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/scheduler.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/scheduler-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-context system:kube-scheduler@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --cluster<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --user<span style="color:#f92672">=</span>system:kube-scheduler <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config use-context system:kube-scheduler@kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 配置admin证书，以及集群上下文等信息</span>
</span></span><span style="display:flex;"><span>cfssl gencert <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -ca-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -config<span style="color:#f92672">=</span>ca-config.json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   -profile<span style="color:#f92672">=</span>kubernetes <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem --embed-certs<span style="color:#f92672">=</span>true --server<span style="color:#f92672">=</span>https://192.168.43.200:8443 --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/admin.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials kubernetes-admin --client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/admin.pem --client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/admin-key.pem --embed-certs<span style="color:#f92672">=</span>true --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/admin.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-context kubernetes-admin@kubernetes --cluster<span style="color:#f92672">=</span>kubernetes --user<span style="color:#f92672">=</span>kubernetes-admin --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/admin.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config use-context kubernetes-admin@kubernetes --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/admin.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建ServiceAccount密钥对</span>
</span></span><span style="display:flex;"><span>openssl genrsa -out /etc/kubernetes/pki/sa.key <span style="color:#ae81ff">2048</span>
</span></span><span style="display:flex;"><span>openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 拷贝证书到其他master节点</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03; <span style="color:#66d9ef">do</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> FILE in <span style="color:#66d9ef">$(</span>ls /etc/kubernetes/pki | grep -v etcd<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span> 
</span></span><span style="display:flex;"><span>        scp /etc/kubernetes/pki/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span> $i:/etc/kubernetes/pki/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>; 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; <span style="color:#66d9ef">do</span> 
</span></span><span style="display:flex;"><span>        scp /etc/kubernetes/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span> $i:/etc/kubernetes/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看证书数量是否为23</span>
</span></span><span style="display:flex;"><span>ls /etc/kubernetes/pki/ | wc -l
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">23</span>
</span></span></code></pre></div><h3 id="etcd集群master">ETCD集群(Master)<a hidden class="anchor" aria-hidden="true" href="#etcd集群master">#</a></h3>
<blockquote>
<p>如果Etcd集群服务器和Kubernetes集群服务器不重合（即独立的Etcd集群），需要根据实际情况配置集群IP。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># master01</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/etcd/etcd.config.yml
</span></span><span style="display:flex;"><span>name: <span style="color:#e6db74">&#39;k8s-master01&#39;</span>
</span></span><span style="display:flex;"><span>data-dir: /var/lib/etcd
</span></span><span style="display:flex;"><span>wal-dir: /var/lib/etcd/wal
</span></span><span style="display:flex;"><span>snapshot-count: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>heartbeat-interval: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>election-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>quota-backend-bytes: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>listen-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.201:2380&#39;</span>
</span></span><span style="display:flex;"><span>listen-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.201:2379,http://127.0.0.1:2379&#39;</span>
</span></span><span style="display:flex;"><span>max-snapshots: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>max-wals: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>cors:
</span></span><span style="display:flex;"><span>initial-advertise-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.201:2380&#39;</span>
</span></span><span style="display:flex;"><span>advertise-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.201:2379&#39;</span>
</span></span><span style="display:flex;"><span>discovery:
</span></span><span style="display:flex;"><span>discovery-fallback: <span style="color:#e6db74">&#39;proxy&#39;</span>
</span></span><span style="display:flex;"><span>discovery-proxy:
</span></span><span style="display:flex;"><span>discovery-srv:
</span></span><span style="display:flex;"><span>initial-cluster: <span style="color:#e6db74">&#39;k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-token: <span style="color:#e6db74">&#39;etcd-k8s-cluster&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-state: <span style="color:#e6db74">&#39;new&#39;</span>
</span></span><span style="display:flex;"><span>strict-reconfig-check: false
</span></span><span style="display:flex;"><span>enable-v2: true
</span></span><span style="display:flex;"><span>enable-pprof: true
</span></span><span style="display:flex;"><span>proxy: <span style="color:#e6db74">&#39;off&#39;</span>
</span></span><span style="display:flex;"><span>proxy-failure-wait: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-refresh-interval: <span style="color:#ae81ff">30000</span>
</span></span><span style="display:flex;"><span>proxy-dial-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>proxy-write-timeout: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-read-timeout: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>client-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>peer-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  peer-client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>debug: false
</span></span><span style="display:flex;"><span>log-package-levels:
</span></span><span style="display:flex;"><span>log-outputs: <span style="color:#f92672">[</span>default<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>force-new-cluster: false
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master02</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/etcd/etcd.config.yml
</span></span><span style="display:flex;"><span>name: <span style="color:#e6db74">&#39;k8s-master02&#39;</span>
</span></span><span style="display:flex;"><span>data-dir: /var/lib/etcd
</span></span><span style="display:flex;"><span>wal-dir: /var/lib/etcd/wal
</span></span><span style="display:flex;"><span>snapshot-count: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>heartbeat-interval: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>election-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>quota-backend-bytes: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>listen-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.202:2380&#39;</span>
</span></span><span style="display:flex;"><span>listen-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.202:2379,http://127.0.0.1:2379&#39;</span>
</span></span><span style="display:flex;"><span>max-snapshots: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>max-wals: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>cors:
</span></span><span style="display:flex;"><span>initial-advertise-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.202:2380&#39;</span>
</span></span><span style="display:flex;"><span>advertise-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.202:2379&#39;</span>
</span></span><span style="display:flex;"><span>discovery:
</span></span><span style="display:flex;"><span>discovery-fallback: <span style="color:#e6db74">&#39;proxy&#39;</span>
</span></span><span style="display:flex;"><span>discovery-proxy:
</span></span><span style="display:flex;"><span>discovery-srv:
</span></span><span style="display:flex;"><span>initial-cluster: <span style="color:#e6db74">&#39;k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-token: <span style="color:#e6db74">&#39;etcd-k8s-cluster&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-state: <span style="color:#e6db74">&#39;new&#39;</span>
</span></span><span style="display:flex;"><span>strict-reconfig-check: false
</span></span><span style="display:flex;"><span>enable-v2: true
</span></span><span style="display:flex;"><span>enable-pprof: true
</span></span><span style="display:flex;"><span>proxy: <span style="color:#e6db74">&#39;off&#39;</span>
</span></span><span style="display:flex;"><span>proxy-failure-wait: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-refresh-interval: <span style="color:#ae81ff">30000</span>
</span></span><span style="display:flex;"><span>proxy-dial-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>proxy-write-timeout: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-read-timeout: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>client-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>peer-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  peer-client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>debug: false
</span></span><span style="display:flex;"><span>log-package-levels:
</span></span><span style="display:flex;"><span>log-outputs: <span style="color:#f92672">[</span>default<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>force-new-cluster: false
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master03</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/etcd/etcd.config.yml
</span></span><span style="display:flex;"><span>name: <span style="color:#e6db74">&#39;k8s-master03&#39;</span>
</span></span><span style="display:flex;"><span>data-dir: /var/lib/etcd
</span></span><span style="display:flex;"><span>wal-dir: /var/lib/etcd/wal
</span></span><span style="display:flex;"><span>snapshot-count: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>heartbeat-interval: <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>election-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>quota-backend-bytes: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>listen-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.203:2380&#39;</span>
</span></span><span style="display:flex;"><span>listen-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.203:2379,http://127.0.0.1:2379&#39;</span>
</span></span><span style="display:flex;"><span>max-snapshots: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>max-wals: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>cors:
</span></span><span style="display:flex;"><span>initial-advertise-peer-urls: <span style="color:#e6db74">&#39;https://192.168.43.203:2380&#39;</span>
</span></span><span style="display:flex;"><span>advertise-client-urls: <span style="color:#e6db74">&#39;https://192.168.43.203:2379&#39;</span>
</span></span><span style="display:flex;"><span>discovery:
</span></span><span style="display:flex;"><span>discovery-fallback: <span style="color:#e6db74">&#39;proxy&#39;</span>
</span></span><span style="display:flex;"><span>discovery-proxy:
</span></span><span style="display:flex;"><span>discovery-srv:
</span></span><span style="display:flex;"><span>initial-cluster: <span style="color:#e6db74">&#39;k8s-master01=https://192.168.43.201:2380,k8s-master02=https://192.168.43.202:2380,k8s-master03=https://192.168.43.203:2380&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-token: <span style="color:#e6db74">&#39;etcd-k8s-cluster&#39;</span>
</span></span><span style="display:flex;"><span>initial-cluster-state: <span style="color:#e6db74">&#39;new&#39;</span>
</span></span><span style="display:flex;"><span>strict-reconfig-check: false
</span></span><span style="display:flex;"><span>enable-v2: true
</span></span><span style="display:flex;"><span>enable-pprof: true
</span></span><span style="display:flex;"><span>proxy: <span style="color:#e6db74">&#39;off&#39;</span>
</span></span><span style="display:flex;"><span>proxy-failure-wait: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-refresh-interval: <span style="color:#ae81ff">30000</span>
</span></span><span style="display:flex;"><span>proxy-dial-timeout: <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>proxy-write-timeout: <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>proxy-read-timeout: <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>client-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>peer-transport-security:
</span></span><span style="display:flex;"><span>  cert-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
</span></span><span style="display:flex;"><span>  key-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
</span></span><span style="display:flex;"><span>  peer-client-cert-auth: true
</span></span><span style="display:flex;"><span>  trusted-ca-file: <span style="color:#e6db74">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
</span></span><span style="display:flex;"><span>  auto-tls: true
</span></span><span style="display:flex;"><span>debug: false
</span></span><span style="display:flex;"><span>log-package-levels:
</span></span><span style="display:flex;"><span>log-outputs: <span style="color:#f92672">[</span>default<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>force-new-cluster: false
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在所有master节点创建etcd服务并启动</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/etcd.service
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Etcd Service
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://coreos.com/etcd/docs/latest/
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Type<span style="color:#f92672">=</span>notify
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/etcd --config-file<span style="color:#f92672">=</span>/etc/etcd/etcd.config.yml
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>on-failure
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>LimitNOFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">65536</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>Alias<span style="color:#f92672">=</span>etcd3.service
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有Master节点创建etcd证书目录并链接证书，否则启动会失败</span>
</span></span><span style="display:flex;"><span>mkdir /etc/kubernetes/pki/etcd
</span></span><span style="display:flex;"><span>ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看etcd集群状态如下即可</span>
</span></span><span style="display:flex;"><span>ETCDCTL_API<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> etcdctl --endpoints<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;192.168.43.203:2379,192.168.43.202:2379,192.168.43.201:2379&#34;</span> --cacert<span style="color:#f92672">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem --cert<span style="color:#f92672">=</span>/etc/kubernetes/pki/etcd/etcd.pem --key<span style="color:#f92672">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out<span style="color:#f92672">=</span>table
</span></span><span style="display:flex;"><span>+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span style="display:flex;"><span>|      ENDPOINT       |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
</span></span><span style="display:flex;"><span>+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span style="display:flex;"><span>| 192.168.43.203:2379 |   fd1372a073304e |   3.5.1 |   <span style="color:#ae81ff">20</span> kB |     false |      false |         <span style="color:#ae81ff">2</span> |          <span style="color:#ae81ff">9</span> |                  <span style="color:#ae81ff">9</span> |        |
</span></span><span style="display:flex;"><span>| 192.168.43.202:2379 | 837ce9c47e0719eb |   3.5.1 |   <span style="color:#ae81ff">20</span> kB |     false |      false |         <span style="color:#ae81ff">2</span> |          <span style="color:#ae81ff">9</span> |                  <span style="color:#ae81ff">9</span> |        |
</span></span><span style="display:flex;"><span>| 192.168.43.201:2379 | e9bf8d99824c9061 |   3.5.1 |   <span style="color:#ae81ff">20</span> kB |      true |      false |         <span style="color:#ae81ff">2</span> |          <span style="color:#ae81ff">9</span> |                  <span style="color:#ae81ff">9</span> |        |
</span></span><span style="display:flex;"><span>+---------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></code></pre></div><h3 id="高可用组件master">高可用组件(Master)<a hidden class="anchor" aria-hidden="true" href="#高可用组件master">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 所有master节点安装Keepalived和haproxy，并创建配置文件目录</span>
</span></span><span style="display:flex;"><span>yum install keepalived haproxy -y
</span></span><span style="display:flex;"><span>mkdir /etc/haproxy
</span></span><span style="display:flex;"><span>mkdir /etc/keepalived
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 为所有master节点添加haproxy配置，配置都一样，检查最后三行主机名和IP地址对应上就行</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/haproxy/haproxy.cfg
</span></span><span style="display:flex;"><span>global
</span></span><span style="display:flex;"><span>  maxconn  <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>  ulimit-n  <span style="color:#ae81ff">16384</span>
</span></span><span style="display:flex;"><span>  log  127.0.0.1 local0 err
</span></span><span style="display:flex;"><span>  stats timeout 30s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>defaults
</span></span><span style="display:flex;"><span>  log global
</span></span><span style="display:flex;"><span>  mode  http
</span></span><span style="display:flex;"><span>  option  httplog
</span></span><span style="display:flex;"><span>  timeout connect <span style="color:#ae81ff">5000</span>
</span></span><span style="display:flex;"><span>  timeout client  <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>  timeout server  <span style="color:#ae81ff">50000</span>
</span></span><span style="display:flex;"><span>  timeout http-request 15s
</span></span><span style="display:flex;"><span>  timeout http-keep-alive 15s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend monitor-in
</span></span><span style="display:flex;"><span>  bind *:33305
</span></span><span style="display:flex;"><span>  mode http
</span></span><span style="display:flex;"><span>  option httplog
</span></span><span style="display:flex;"><span>  monitor-uri /monitor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>frontend k8s-master
</span></span><span style="display:flex;"><span>  bind 0.0.0.0:8443
</span></span><span style="display:flex;"><span>  bind 127.0.0.1:8443
</span></span><span style="display:flex;"><span>  mode tcp
</span></span><span style="display:flex;"><span>  option tcplog
</span></span><span style="display:flex;"><span>  tcp-request inspect-delay 5s
</span></span><span style="display:flex;"><span>  default_backend k8s-master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>backend k8s-master
</span></span><span style="display:flex;"><span>  mode tcp
</span></span><span style="display:flex;"><span>  option tcplog
</span></span><span style="display:flex;"><span>  option tcp-check
</span></span><span style="display:flex;"><span>  balance roundrobin
</span></span><span style="display:flex;"><span>  default-server inter 10s downinter 5s rise <span style="color:#ae81ff">2</span> fall <span style="color:#ae81ff">2</span> slowstart 60s maxconn <span style="color:#ae81ff">250</span> maxqueue <span style="color:#ae81ff">256</span> weight <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>  server k8s-master01  192.168.43.201:6443  check
</span></span><span style="display:flex;"><span>  server k8s-master02  192.168.43.202:6443  check
</span></span><span style="display:flex;"><span>  server k8s-master03  192.168.43.203:6443  check
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># keepalived配置不一样，注意区分网卡名、IP地址和虚拟IP地址</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查服务器网卡名</span>
</span></span><span style="display:flex;"><span>ip a 或 ifconfig
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master01 Keepalived配置</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    router_id LVS_DEVEL
</span></span><span style="display:flex;"><span>    script_user root
</span></span><span style="display:flex;"><span>    enable_script_security
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_apiserver <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#e6db74">&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
</span></span><span style="display:flex;"><span>    interval <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    weight -5
</span></span><span style="display:flex;"><span>    fall <span style="color:#ae81ff">2</span>  
</span></span><span style="display:flex;"><span>    rise <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    state MASTER
</span></span><span style="display:flex;"><span>    interface ens33
</span></span><span style="display:flex;"><span>    mcast_src_ip 192.168.43.201
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#ae81ff">101</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass K8SHA_KA_AUTH
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        192.168.43.200
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       chk_apiserver
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master02 Keepalived配置</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    router_id LVS_DEVEL
</span></span><span style="display:flex;"><span>    script_user root
</span></span><span style="display:flex;"><span>    enable_script_security
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_apiserver <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#e6db74">&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
</span></span><span style="display:flex;"><span>    interval <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    weight -5
</span></span><span style="display:flex;"><span>    fall <span style="color:#ae81ff">2</span>  
</span></span><span style="display:flex;"><span>    rise <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    state BACKUP
</span></span><span style="display:flex;"><span>    interface ens33
</span></span><span style="display:flex;"><span>    mcast_src_ip 192.168.43.202
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass K8SHA_KA_AUTH
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        192.168.43.200
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       chk_apiserver
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># k8s-master03 Keepalived配置</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>! Configuration File <span style="color:#66d9ef">for</span> keepalived
</span></span><span style="display:flex;"><span>global_defs <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    router_id LVS_DEVEL
</span></span><span style="display:flex;"><span>    script_user root
</span></span><span style="display:flex;"><span>    enable_script_security
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_script chk_apiserver <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    script <span style="color:#e6db74">&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
</span></span><span style="display:flex;"><span>    interval <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    weight -5
</span></span><span style="display:flex;"><span>    fall <span style="color:#ae81ff">2</span>  
</span></span><span style="display:flex;"><span>    rise <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    state BACKUP
</span></span><span style="display:flex;"><span>    interface ens33
</span></span><span style="display:flex;"><span>    mcast_src_ip 192.168.43.203
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass K8SHA_KA_AUTH
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        192.168.43.200
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    track_script <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       chk_apiserver
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有master节点配置Keepalived健康检查脚本</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/keepalived/check_apiserver.sh 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash</span>
</span></span><span style="display:flex;"><span>err<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> k in <span style="color:#66d9ef">$(</span>seq <span style="color:#ae81ff">1</span> 3<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    check_code<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>pgrep haproxy<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $check_code <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        err<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>expr $err + 1<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>        sleep <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        err<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        break
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> $err !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;0&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;systemctl stop keepalived&#34;</span>
</span></span><span style="display:flex;"><span>    /usr/bin/systemctl stop keepalived
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 赋予可执行权限</span>
</span></span><span style="display:flex;"><span>chmod +x /etc/keepalived/check_apiserver.sh
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动haproxy和Keepalived并加入开机启动</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now haproxy <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查服务是否正常</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这种告警可以忽略：Mar 06 14:03:35 k8s-master01 haproxy-systemd-wrapper[1981]: [WARNING] 064/140335 (1982) : config : frontend &#39;GLOBAL&#39; has no &#39;bind&#39;</span>
</span></span><span style="display:flex;"><span>systemctl status haproxy
</span></span><span style="display:flex;"><span>systemctl status keepalived
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 测试一波</span>
</span></span><span style="display:flex;"><span>telnet k8s-master-vip <span style="color:#ae81ff">8443</span>
</span></span><span style="display:flex;"><span>ping k8s-master-vip
</span></span></code></pre></div><h3 id="配置集群组件">配置集群组件<a hidden class="anchor" aria-hidden="true" href="#配置集群组件">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 所有节点创建以下集群资源目录</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes
</span></span></code></pre></div><p><strong>Apiserver(Master)</strong></p>
<ul>
<li>所有master节点配置kube-apiserver服务</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># service网段为10.96.0.0/12，可自行设置，其他参数按需配置即可</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master01配置</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kube-apiserver.service 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes API Server
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-apiserver <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --allow-privileged<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --bind-address<span style="color:#f92672">=</span>0.0.0.0  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --secure-port<span style="color:#f92672">=</span><span style="color:#ae81ff">6443</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --advertise-address<span style="color:#f92672">=</span>192.168.43.201 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-cluster-ip-range<span style="color:#f92672">=</span>10.96.0.0/12  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-node-port-range<span style="color:#f92672">=</span>30000-32767  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-servers<span style="color:#f92672">=</span>https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-cafile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-certfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-keyfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-private-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.pub  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-signing-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.key  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-issuer<span style="color:#f92672">=</span>https://kubernetes.default.svc.cluster.local <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-preferred-address-types<span style="color:#f92672">=</span>InternalIP,ExternalIP,Hostname  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-admission-plugins<span style="color:#f92672">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --authorization-mode<span style="color:#f92672">=</span>Node,RBAC  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-bootstrap-token-auth<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-allowed-names<span style="color:#f92672">=</span>aggregator  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-group-headers<span style="color:#f92672">=</span>X-Remote-Group  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-extra-headers-prefix<span style="color:#f92672">=</span>X-Remote-Extra-  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-username-headers<span style="color:#f92672">=</span>X-Remote-User
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># --token-auth-file=/etc/kubernetes/token.csv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>on-failure
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>LimitNOFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master02配置</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt;  /usr/lib/systemd/system/kube-apiserver.service 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes API Server
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-apiserver <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --allow-privileged<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --bind-address<span style="color:#f92672">=</span>0.0.0.0  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --secure-port<span style="color:#f92672">=</span><span style="color:#ae81ff">6443</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --advertise-address<span style="color:#f92672">=</span>192.168.43.202 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-cluster-ip-range<span style="color:#f92672">=</span>10.96.0.0/12  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-node-port-range<span style="color:#f92672">=</span>30000-32767  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-servers<span style="color:#f92672">=</span>https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-cafile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-certfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-keyfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-private-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.pub  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-signing-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.key  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-issuer<span style="color:#f92672">=</span>https://kubernetes.default.svc.cluster.local <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-preferred-address-types<span style="color:#f92672">=</span>InternalIP,ExternalIP,Hostname  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-admission-plugins<span style="color:#f92672">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --authorization-mode<span style="color:#f92672">=</span>Node,RBAC  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-bootstrap-token-auth<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-allowed-names<span style="color:#f92672">=</span>aggregator  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-group-headers<span style="color:#f92672">=</span>X-Remote-Group  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-extra-headers-prefix<span style="color:#f92672">=</span>X-Remote-Extra-  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-username-headers<span style="color:#f92672">=</span>X-Remote-User
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># --token-auth-file=/etc/kubernetes/token.csv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>on-failure
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>LimitNOFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># master03配置</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kube-apiserver.service 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes API Server
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-apiserver <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --allow-privileged<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --bind-address<span style="color:#f92672">=</span>0.0.0.0  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --secure-port<span style="color:#f92672">=</span><span style="color:#ae81ff">6443</span>  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --advertise-address<span style="color:#f92672">=</span>192.168.43.203 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-cluster-ip-range<span style="color:#f92672">=</span>10.96.0.0/12  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-node-port-range<span style="color:#f92672">=</span>30000-32767  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-servers<span style="color:#f92672">=</span>https://192.168.43.201:2379,https://192.168.43.202:2379,https://192.168.43.203:2379 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-cafile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-certfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --etcd-keyfile<span style="color:#f92672">=</span>/etc/etcd/ssl/etcd-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --tls-private-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-certificate<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-client-key<span style="color:#f92672">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.pub  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-signing-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.key  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-issuer<span style="color:#f92672">=</span>https://kubernetes.default.svc.cluster.local <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubelet-preferred-address-types<span style="color:#f92672">=</span>InternalIP,ExternalIP,Hostname  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-admission-plugins<span style="color:#f92672">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --authorization-mode<span style="color:#f92672">=</span>Node,RBAC  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --enable-bootstrap-token-auth<span style="color:#f92672">=</span>true  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --proxy-client-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-allowed-names<span style="color:#f92672">=</span>aggregator  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-group-headers<span style="color:#f92672">=</span>X-Remote-Group  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-extra-headers-prefix<span style="color:#f92672">=</span>X-Remote-Extra-  <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-username-headers<span style="color:#f92672">=</span>X-Remote-User
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># --token-auth-file=/etc/kubernetes/token.csv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>on-failure
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>LimitNOFILE<span style="color:#f92672">=</span><span style="color:#ae81ff">65535</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动kube-apiserver</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now kube-apiserver
</span></span></code></pre></div><p><strong>ControllerManager(Master)</strong></p>
<p>所有Master节点配置kube-controller-manager服务，配置都一样</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Pod网段是172.16.0.0/12，可按需更改，不要和其他在用网段冲突即可</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 给所有master节点配置服务</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kube-controller-manager.service
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes Controller Manager
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-controller-manager <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --root-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --cluster-signing-cert-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --cluster-signing-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca-key.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --service-account-private-key-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/sa.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/controller-manager.kubeconfig <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --feature-gates<span style="color:#f92672">=</span>LegacyServiceAccountTokenNoAutoGeneration<span style="color:#f92672">=</span>false <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --leader-elect<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --use-service-account-credentials<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --node-monitor-grace-period<span style="color:#f92672">=</span>40s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --node-monitor-period<span style="color:#f92672">=</span>5s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --pod-eviction-timeout<span style="color:#f92672">=</span>2m0s <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --controllers<span style="color:#f92672">=</span>*,bootstrapsigner,tokencleaner <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --allocate-node-cidrs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --cluster-cidr<span style="color:#f92672">=</span>172.16.0.0/12 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --requestheader-client-ca-file<span style="color:#f92672">=</span>/etc/kubernetes/pki/front-proxy-ca.pem <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --node-cidr-mask-size<span style="color:#f92672">=</span><span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>always
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now kube-controller-manager
</span></span></code></pre></div><p><strong>Scheduler(Master)</strong></p>
<p>所有Master节点配置kube-scheduler服务，配置都一样</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kube-scheduler.service 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes Scheduler
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-scheduler <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --leader-elect<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --authentication-kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --authorization-kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/scheduler.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>always
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now kube-scheduler
</span></span></code></pre></div><p><strong>确认集群组件状态</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 所有Master节点均检查，-l参数输出完整信息</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果有E开头的报错，需要排查解决一下，常见问题是IP冲突、证书错误</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># W告警可暂时忽略</span>
</span></span><span style="display:flex;"><span>systemctl status kube-apiserver -l
</span></span><span style="display:flex;"><span>systemctl status kube-controller-manager -l
</span></span><span style="display:flex;"><span>systemctl status kube-scheduler -l
</span></span></code></pre></div><h3 id="配置tls-bootstrapping">配置TLS Bootstrapping<a hidden class="anchor" aria-hidden="true" href="#配置tls-bootstrapping">#</a></h3>
<p>只需在master01节点配置，TLS Bootstrapping的官方说明请见：<a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/"  target="_blank" rel="noopener" style="color:#42b983" ;>TLS Bootstrapping</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /root/k8s-ha-install/bootstrap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看一下secret，name后要和token-id一致，token-id.token-secret和集群设置--token=对应上</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 bootstrap<span style="color:#f92672">]</span><span style="color:#75715e"># cat bootstrap.secret.yaml </span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Secret
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: bootstrap-token-c8ad9c
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>type: bootstrap.kubernetes.io/token
</span></span><span style="display:flex;"><span>stringData:
</span></span><span style="display:flex;"><span>  description: <span style="color:#e6db74">&#34;The default bootstrap token generated by &#39;kubelet &#39;.&#34;</span>
</span></span><span style="display:flex;"><span>  token-id: c8ad9c
</span></span><span style="display:flex;"><span>  token-secret: 2e4d610cf3e7426e
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem --embed-certs<span style="color:#f92672">=</span>true --server<span style="color:#f92672">=</span>https://192.168.43.200:8443 --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials tls-bootstrap-token-user --token<span style="color:#f92672">=</span>c8ad9c.2e4d610cf3e7426e --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-context tls-bootstrap-token-user@kubernetes --cluster<span style="color:#f92672">=</span>kubernetes --user<span style="color:#f92672">=</span>tls-bootstrap-token-user --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config use-context tls-bootstrap-token-user@kubernetes --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建配置目录，拷贝admin.kubeconfig文件为config，授权kubectl，使得当前用户可以使用kubectl创建资源</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 其他master节点如果需要使用kubectl命令创建资源，也可以拷贝文件过去</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下面是没有授权的情况</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [root@k8s-master01 bootstrap]# kubectl get cs</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The connection to the server localhost:8080 was refused - did you specify the right host or port?</span>
</span></span><span style="display:flex;"><span>mkdir -p /root/.kube;cp /etc/kubernetes/admin.kubeconfig /root/.kube/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 授权后查看集群状态</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 bootstrap<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get cs</span>
</span></span><span style="display:flex;"><span>Warning: v1 ComponentStatus is deprecated in v1.19+
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE                         ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span>,<span style="color:#e6db74">&#34;reason&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>etcd-1               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span>,<span style="color:#e6db74">&#34;reason&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>etcd-2               Healthy   <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;health&#34;</span>:<span style="color:#e6db74">&#34;true&#34;</span>,<span style="color:#e6db74">&#34;reason&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建bootstrap-secret</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 bootstrap<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f bootstrap.secret.yaml </span>
</span></span><span style="display:flex;"><span>secret/bootstrap-token-c8ad9c created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
</span></span></code></pre></div><h3 id="配置kubelet">配置Kubelet<a hidden class="anchor" aria-hidden="true" href="#配置kubelet">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 从master01拷贝证书文件到其他节点</span>
</span></span><span style="display:flex;"><span>cd /etc/kubernetes/
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    ssh $i mkdir -p /etc/kubernetes/pki
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      scp /etc/kubernetes/$FILE $i:/etc/kubernetes/<span style="color:#e6db74">${</span>FILE<span style="color:#e6db74">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有节点配置kubelet服务</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kubelet.service
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes Kubelet
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>always
</span></span><span style="display:flex;"><span>StartLimitInterval<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Runtime为Containerd，kubelet服务的配置文件</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/systemd/system/kubelet.service.d/10-kubelet.conf
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;KUBELET_SYSTEM_ARGS=--container-runtime=remote --runtime-request-timeout=15m --container-runtime-endpoint=unix:///run/containerd/containerd.sock&#34;</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml&#34;</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node=&#39;&#39; &#34;</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_SYSTEM_ARGS $KUBELET_EXTRA_ARGS
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建kubelet配置文件，对应上面Environment配置KUBELET_CONFIG_ARGS</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># clusterDNS配置为service网段的第十个地址</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/kubernetes/kubelet-conf.yml
</span></span><span style="display:flex;"><span>apiVersion: kubelet.config.k8s.io/v1beta1
</span></span><span style="display:flex;"><span>kind: KubeletConfiguration
</span></span><span style="display:flex;"><span>address: 0.0.0.0
</span></span><span style="display:flex;"><span>port: <span style="color:#ae81ff">10250</span>
</span></span><span style="display:flex;"><span>readOnlyPort: <span style="color:#ae81ff">10255</span>
</span></span><span style="display:flex;"><span>authentication:
</span></span><span style="display:flex;"><span>  anonymous:
</span></span><span style="display:flex;"><span>    enabled: false
</span></span><span style="display:flex;"><span>  webhook:
</span></span><span style="display:flex;"><span>    cacheTTL: 2m0s
</span></span><span style="display:flex;"><span>    enabled: true
</span></span><span style="display:flex;"><span>  x509:
</span></span><span style="display:flex;"><span>    clientCAFile: /etc/kubernetes/pki/ca.pem
</span></span><span style="display:flex;"><span>authorization:
</span></span><span style="display:flex;"><span>  mode: Webhook
</span></span><span style="display:flex;"><span>  webhook:
</span></span><span style="display:flex;"><span>    cacheAuthorizedTTL: 5m0s
</span></span><span style="display:flex;"><span>    cacheUnauthorizedTTL: 30s
</span></span><span style="display:flex;"><span>cgroupDriver: systemd
</span></span><span style="display:flex;"><span>cgroupsPerQOS: true
</span></span><span style="display:flex;"><span>clusterDNS:
</span></span><span style="display:flex;"><span>- 10.96.0.10
</span></span><span style="display:flex;"><span>clusterDomain: cluster.local
</span></span><span style="display:flex;"><span>containerLogMaxFiles: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>containerLogMaxSize: 10Mi
</span></span><span style="display:flex;"><span>contentType: application/vnd.kubernetes.protobuf
</span></span><span style="display:flex;"><span>cpuCFSQuota: true
</span></span><span style="display:flex;"><span>cpuManagerPolicy: none
</span></span><span style="display:flex;"><span>cpuManagerReconcilePeriod: 10s
</span></span><span style="display:flex;"><span>enableControllerAttachDetach: true
</span></span><span style="display:flex;"><span>enableDebuggingHandlers: true
</span></span><span style="display:flex;"><span>enforceNodeAllocatable:
</span></span><span style="display:flex;"><span>- pods
</span></span><span style="display:flex;"><span>eventBurst: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>eventRecordQPS: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>evictionHard:
</span></span><span style="display:flex;"><span>  imagefs.available: 15%
</span></span><span style="display:flex;"><span>  memory.available: 100Mi
</span></span><span style="display:flex;"><span>  nodefs.available: 10%
</span></span><span style="display:flex;"><span>  nodefs.inodesFree: 5%
</span></span><span style="display:flex;"><span>evictionPressureTransitionPeriod: 5m0s
</span></span><span style="display:flex;"><span>failSwapOn: true
</span></span><span style="display:flex;"><span>fileCheckFrequency: 20s
</span></span><span style="display:flex;"><span>hairpinMode: promiscuous-bridge
</span></span><span style="display:flex;"><span>healthzBindAddress: 127.0.0.1
</span></span><span style="display:flex;"><span>healthzPort: <span style="color:#ae81ff">10248</span>
</span></span><span style="display:flex;"><span>httpCheckFrequency: 20s
</span></span><span style="display:flex;"><span>imageGCHighThresholdPercent: <span style="color:#ae81ff">85</span>
</span></span><span style="display:flex;"><span>imageGCLowThresholdPercent: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>imageMinimumGCAge: 2m0s
</span></span><span style="display:flex;"><span>iptablesDropBit: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>iptablesMasqueradeBit: <span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span>kubeAPIBurst: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>kubeAPIQPS: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>makeIPTablesUtilChains: true
</span></span><span style="display:flex;"><span>maxOpenFiles: <span style="color:#ae81ff">1000000</span>
</span></span><span style="display:flex;"><span>maxPods: <span style="color:#ae81ff">110</span>
</span></span><span style="display:flex;"><span>nodeStatusUpdateFrequency: 10s
</span></span><span style="display:flex;"><span>oomScoreAdj: -999
</span></span><span style="display:flex;"><span>podPidsLimit: -1
</span></span><span style="display:flex;"><span>registryBurst: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>registryPullQPS: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>resolvConf: /etc/resolv.conf
</span></span><span style="display:flex;"><span>rotateCertificates: true
</span></span><span style="display:flex;"><span>runtimeRequestTimeout: 2m0s
</span></span><span style="display:flex;"><span>serializeImagePulls: true
</span></span><span style="display:flex;"><span>staticPodPath: /etc/kubernetes/manifests
</span></span><span style="display:flex;"><span>streamingConnectionIdleTimeout: 4h0m0s
</span></span><span style="display:flex;"><span>syncFrequency: 1m0s
</span></span><span style="display:flex;"><span>volumeStatsAggPeriod: 1m0s
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动服务</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 以k8s-master01为例查看运行日志和状态，只有CNI一处报错表示配置正确，后面CNI配置好后就会正常</span>
</span></span><span style="display:flex;"><span>tail -f /var/log/messages
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Apr <span style="color:#ae81ff">21</span> 16:15:56 k8s-master01 kubelet: E0421 16:15:56.608747    <span style="color:#ae81ff">7169</span> kubelet.go:2475<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Container runtime network not ready&#34;</span> networkReady<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># systemctl status kubelet</span>
</span></span><span style="display:flex;"><span>● kubelet.service - Kubernetes Kubelet
</span></span><span style="display:flex;"><span>   Loaded: loaded <span style="color:#f92672">(</span>/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  Drop-In: /etc/systemd/system/kubelet.service.d
</span></span><span style="display:flex;"><span>           └─10-kubelet.conf
</span></span><span style="display:flex;"><span>   Active: active <span style="color:#f92672">(</span>running<span style="color:#f92672">)</span> since 五 2023-04-21 16:09:00 CST; 6min ago
</span></span><span style="display:flex;"><span>     Docs: https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span> Main PID: <span style="color:#ae81ff">7169</span> <span style="color:#f92672">(</span>kubelet<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    Tasks: <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>   Memory: 40.6M
</span></span><span style="display:flex;"><span>   CGroup: /system.slice/kubelet.service
</span></span><span style="display:flex;"><span>           └─7169 /usr/local/bin/kubelet --bootstrap-kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig<span style="color:#f92672">=</span>/etc/kuberne...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>4月 <span style="color:#ae81ff">21</span> 16:14:26 k8s-master01 kubelet<span style="color:#f92672">[</span>7169<span style="color:#f92672">]</span>: E0421 16:14:26.578931    <span style="color:#ae81ff">7169</span> kubelet.go:2475<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Container runtime network not read...alized&#34;</span>
</span></span><span style="display:flex;"><span>4月 <span style="color:#ae81ff">21</span> 16:14:31 k8s-master01 kubelet<span style="color:#f92672">[</span>7169<span style="color:#f92672">]</span>: E0421 16:14:31.580077    <span style="color:#ae81ff">7169</span> kubelet.go:2475<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;Container runtime network not read...alized&#34;</span>
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 并且此时节点状态应该是可查询且处于NotReady，CNI配置后就会ready</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME           STATUS     ROLES    AGE     VERSION
</span></span><span style="display:flex;"><span>k8s-master01   NotReady   &lt;none&gt;   7m12s   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master02   NotReady   &lt;none&gt;   7m11s   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master03   NotReady   &lt;none&gt;   7m10s   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node01     NotReady   &lt;none&gt;   7m24s   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node02     NotReady   &lt;none&gt;   7m12s   v1.26.4
</span></span></code></pre></div><h3 id="配置kube-proxy">配置Kube-proxy<a hidden class="anchor" aria-hidden="true" href="#配置kube-proxy">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 只需在k8s-master01上执行</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install
</span></span><span style="display:flex;"><span>kubectl -n kube-system create serviceaccount kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create clusterrolebinding system:kube-proxy --clusterrole system:node-proxier --serviceaccount kube-system:kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SECRET<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl -n kube-system get sa/kube-proxy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    --output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.secrets[0].name}&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JWT_TOKEN<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>kubectl -n kube-system get secret/$SECRET <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--output<span style="color:#f92672">=</span>jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.data.token}&#39;</span> | base64 -d<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PKI_DIR<span style="color:#f92672">=</span>/etc/kubernetes/pki
</span></span><span style="display:flex;"><span>K8S_DIR<span style="color:#f92672">=</span>/etc/kubernetes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-cluster kubernetes --certificate-authority<span style="color:#f92672">=</span>/etc/kubernetes/pki/ca.pem --embed-certs<span style="color:#f92672">=</span>true     --server<span style="color:#f92672">=</span>https://192.168.43.200:8443 --kubeconfig<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>K8S_DIR<span style="color:#e6db74">}</span>/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials kubernetes --token<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>JWT_TOKEN<span style="color:#e6db74">}</span> --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-context kubernetes --cluster<span style="color:#f92672">=</span>kubernetes --user<span style="color:#f92672">=</span>kubernetes --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config use-context kubernetes --kubeconfig<span style="color:#f92672">=</span>/etc/kubernetes/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 从k8s-master01将kubeconfig拷贝到其他节点</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in k8s-master02 k8s-master03 k8s-node01 k8s-node02; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>     scp /etc/kubernetes/kube-proxy.kubeconfig $i:/etc/kubernetes/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有节点配置kube-proxy服务</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /usr/lib/systemd/system/kube-proxy.service
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Kubernetes Kube Proxy
</span></span><span style="display:flex;"><span>Documentation<span style="color:#f92672">=</span>https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/local/bin/kube-proxy <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --config<span style="color:#f92672">=</span>/etc/kubernetes/kube-proxy.yaml <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --v<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Restart<span style="color:#f92672">=</span>always
</span></span><span style="display:flex;"><span>RestartSec<span style="color:#f92672">=</span>10s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所有节点配置kube-proxy.yaml,clusterCIDR为pod网段</span>
</span></span><span style="display:flex;"><span>cat &lt;&lt; <span style="color:#e6db74">&#34;EOF&#34;</span> &gt; /etc/kubernetes/kube-proxy.yaml
</span></span><span style="display:flex;"><span>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span style="display:flex;"><span>bindAddress: 0.0.0.0
</span></span><span style="display:flex;"><span>clientConnection:
</span></span><span style="display:flex;"><span>  acceptContentTypes: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  burst: <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>  contentType: application/vnd.kubernetes.protobuf
</span></span><span style="display:flex;"><span>  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
</span></span><span style="display:flex;"><span>  qps: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>clusterCIDR: 172.16.0.0/12 
</span></span><span style="display:flex;"><span>configSyncPeriod: 15m0s
</span></span><span style="display:flex;"><span>conntrack:
</span></span><span style="display:flex;"><span>  max: null
</span></span><span style="display:flex;"><span>  maxPerCore: <span style="color:#ae81ff">32768</span>
</span></span><span style="display:flex;"><span>  min: <span style="color:#ae81ff">131072</span>
</span></span><span style="display:flex;"><span>  tcpCloseWaitTimeout: 1h0m0s
</span></span><span style="display:flex;"><span>  tcpEstablishedTimeout: 24h0m0s
</span></span><span style="display:flex;"><span>enableProfiling: false
</span></span><span style="display:flex;"><span>healthzBindAddress: 0.0.0.0:10256
</span></span><span style="display:flex;"><span>hostnameOverride: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>iptables:
</span></span><span style="display:flex;"><span>  masqueradeAll: false
</span></span><span style="display:flex;"><span>  masqueradeBit: <span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span>  minSyncPeriod: 0s
</span></span><span style="display:flex;"><span>  syncPeriod: 30s
</span></span><span style="display:flex;"><span>ipvs:
</span></span><span style="display:flex;"><span>  masqueradeAll: true
</span></span><span style="display:flex;"><span>  minSyncPeriod: 5s
</span></span><span style="display:flex;"><span>  scheduler: <span style="color:#e6db74">&#34;rr&#34;</span>
</span></span><span style="display:flex;"><span>  syncPeriod: 30s
</span></span><span style="display:flex;"><span>kind: KubeProxyConfiguration
</span></span><span style="display:flex;"><span>metricsBindAddress: 127.0.0.1:10249
</span></span><span style="display:flex;"><span>mode: <span style="color:#e6db74">&#34;ipvs&#34;</span>
</span></span><span style="display:flex;"><span>nodePortAddresses: null
</span></span><span style="display:flex;"><span>oomScoreAdj: -999
</span></span><span style="display:flex;"><span>portRange: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>udpIdleTimeout: 250ms
</span></span><span style="display:flex;"><span>EOF
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#f92672">&amp;&amp;</span> systemctl enable --now kube-proxy
</span></span></code></pre></div><h3 id="配置calico">配置Calico<a hidden class="anchor" aria-hidden="true" href="#配置calico">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># k8s-master01上执行，更改calico中Pod网段为自己的</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install/calico/
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#POD_CIDR#172.16.0.0/12#g&#34;</span> calico.yaml
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 检查是否更改成功</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># grep &#34;IPV4POOL_CIDR&#34; calico.yaml  -A 1</span>
</span></span><span style="display:flex;"><span>            - name: CALICO_IPV4POOL_CIDR
</span></span><span style="display:flex;"><span>              value: <span style="color:#e6db74">&#34;172.16.0.0/12&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 应用calico</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f calico.yaml</span>
</span></span><span style="display:flex;"><span>poddisruptionbudget.policy/calico-kube-controllers created
</span></span><span style="display:flex;"><span>poddisruptionbudget.policy/calico-typha created
</span></span><span style="display:flex;"><span>serviceaccount/calico-kube-controllers created
</span></span><span style="display:flex;"><span>serviceaccount/calico-node created
</span></span><span style="display:flex;"><span>configmap/calico-config created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/calico-node created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/calico-node created
</span></span><span style="display:flex;"><span>service/calico-typha created
</span></span><span style="display:flex;"><span>daemonset.apps/calico-node created
</span></span><span style="display:flex;"><span>deployment.apps/calico-kube-controllers created
</span></span><span style="display:flex;"><span>deployment.apps/calico-typha created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># （中间状态）在calico生效过程中查看各节点污点状态，发现均有不可调度污点，不必管他，等待calico生效即可，这种污点是kubernetes集群保护机制，在节点处于not ready状态时，节点不可调度</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe node| grep Taints:</span>
</span></span><span style="display:flex;"><span>Taints:             node.kubernetes.io/not-ready:NoSchedule
</span></span><span style="display:flex;"><span>Taints:             node.kubernetes.io/not-ready:NoSchedule
</span></span><span style="display:flex;"><span>Taints:             node.kubernetes.io/not-ready:NoSchedule
</span></span><span style="display:flex;"><span>Taints:             node.kubernetes.io/not-ready:NoSchedule
</span></span><span style="display:flex;"><span>Taints:             node.kubernetes.io/not-ready:NoSchedule
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># calico Pod处于Running后集群网络将建立，node将处于Ready状态，calico建立网络取决于电脑性能（硬件和网络环境），一般几分钟即可完成，性能差的可能会花费更长时间</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po -A</span>
</span></span><span style="display:flex;"><span>NAMESPACE     NAME                                       READY   STATUS    RESTARTS      AGE
</span></span><span style="display:flex;"><span>kube-system   calico-kube-controllers-6bd6b69df9-5nwkl   1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span>kube-system   calico-node-8cvcd                          1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span>kube-system   calico-node-96mx8                          1/1     Running   <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>36s ago<span style="color:#f92672">)</span>   10m
</span></span><span style="display:flex;"><span>kube-system   calico-node-f49rb                          1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span>kube-system   calico-node-rgs7f                          1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span>kube-system   calico-node-vzrls                          1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span>kube-system   calico-typha-77fc8866f5-h9bsj              1/1     Running   <span style="color:#ae81ff">0</span>             10m
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看集群状态和资源</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 calico<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME           STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master01   Ready    &lt;none&gt;   23m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master02   Ready    &lt;none&gt;   23m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master03   Ready    &lt;none&gt;   23m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node01     Ready    &lt;none&gt;   23m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node02     Ready    &lt;none&gt;   23m   v1.26.4
</span></span></code></pre></div><h3 id="配置coredns">配置CoreDNS<a hidden class="anchor" aria-hidden="true" href="#配置coredns">#</a></h3>
<ul>
<li>在k8s-master01操作</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 如果更改了k8s service的网段需要将coredns的serviceIP改成k8s service网段的第十个IP</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install/
</span></span><span style="display:flex;"><span>COREDNS_SERVICE_IP<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>kubectl get svc | grep kubernetes | awk <span style="color:#e6db74">&#39;{print $3}&#39;</span><span style="color:#e6db74">`</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#34;s#KUBEDNS_SERVICE_IP#</span><span style="color:#e6db74">${</span>COREDNS_SERVICE_IP<span style="color:#e6db74">}</span><span style="color:#e6db74">#g&#34;</span> CoreDNS/coredns.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f CoreDNS/coredns.yaml 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 k8s-ha-install<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -A | grep coredns</span>
</span></span><span style="display:flex;"><span>kube-system   coredns-5db5696c7-tsqts                    1/1     Running   <span style="color:#ae81ff">0</span>          80s
</span></span></code></pre></div><h2 id="配置metrics">配置Metrics<a hidden class="anchor" aria-hidden="true" href="#配置metrics">#</a></h2>
<ul>
<li>在k8s-master01操作</li>
</ul>
<p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /root/k8s-ha-install/metrics-server
</span></span><span style="display:flex;"><span>kubectl  create -f . 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 等待metrics-server部署好后，便可使用</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 metrics-server<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl top nodes</span>
</span></span><span style="display:flex;"><span>NAME           CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>   CPU%   MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>   MEMORY%   
</span></span><span style="display:flex;"><span>k8s-master01   186m         9%     1094Mi          58%       
</span></span><span style="display:flex;"><span>k8s-master02   192m         9%     1176Mi          62%       
</span></span><span style="display:flex;"><span>k8s-master03   176m         8%     1123Mi          60%       
</span></span><span style="display:flex;"><span>k8s-node01     72m          3%     463Mi           24%       
</span></span><span style="display:flex;"><span>k8s-node02     66m          3%     472Mi           25%  
</span></span></code></pre></div><h2 id="配置dashboard">配置Dashboard<a hidden class="anchor" aria-hidden="true" href="#配置dashboard">#</a></h2>
<p>Dashboard是一个展示Kubernetes集群资源和Pod日志，甚至可以执行容器命令的web控制台。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 直接部署即可</span>
</span></span><span style="display:flex;"><span>cd /root/k8s-ha-install/dashboard/
</span></span><span style="display:flex;"><span>kubectl apply -f .
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 查看dashboard端口，默认是NodePort模式，访问集群内任意节点的32486端口即可</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc -A | grep dash</span>
</span></span><span style="display:flex;"><span>kubernetes-dashboard   dashboard-metrics-scraper   ClusterIP   10.111.39.8      &lt;none&gt;        8000/TCP                 12m
</span></span><span style="display:flex;"><span>kubernetes-dashboard   kubernetes-dashboard        NodePort    10.98.143.126    &lt;none&gt;        443:32486/TCP            12m
</span></span></code></pre></div><p>访问dashboard：<a href="https://%e9%9b%86%e7%be%a4%e5%86%85%e4%bb%bb%e6%84%8f%e8%8a%82%e7%82%b9IP:32486"  target="_blank" rel="noopener" style="color:#42b983" ;>https://集群内任意节点IP:32486</a></p>
<p>发现提示隐私设置错误的问题，解决方法是在Chrome浏览器启动参数加入<code>--test-type --ignore-certificate-errors</code>，再访问就没有这个提示</p>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20211213154024.png" alt="20211213154024"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 获取登陆令牌（token）</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 dashboard<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk &#39;{print $1}&#39;)</span>
</span></span><span style="display:flex;"><span>Name:         admin-user-token-cj2kt
</span></span><span style="display:flex;"><span>Namespace:    kube-system
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  kubernetes.io/service-account.name: admin-user
</span></span><span style="display:flex;"><span>              kubernetes.io/service-account.uid: c86fbde2-36ea-4dd3-94fd-8ce8012fdf22
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Type:  kubernetes.io/service-account-token
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Data
</span></span><span style="display:flex;"><span><span style="color:#f92672">====</span>
</span></span><span style="display:flex;"><span>ca.crt:     <span style="color:#ae81ff">1411</span> bytes
</span></span><span style="display:flex;"><span>namespace:  <span style="color:#ae81ff">11</span> bytes
</span></span><span style="display:flex;"><span>token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImFPeklobHBkNVRzZzZYVF9nbG5BMTgwOHdvMUNkV2FGbW1wdmUzZzdJRXcifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWNqMmt0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJjODZmYmRlMi0zNmVhLTRkZDMtOTRmZC04Y2U4MDEyZmRmMjIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.YgxIsaxR-hfyT9YLGdszggQ0Rvoc4SvyqswgvHz2ySc27q8lAQ7EJxhze3bhrdTL79z3J30T6vmuA5Be3kq_c2r42r2Iy-pC92t8xTISlPWEl7JfSg8GSbX2-UxUM_wqCmbMO3RWGYW5FpzrJ2pSVaeIGlu2JmYTugtS50LCFi87DmP2tDAKLQfh1NRylpEPI1AJPbl41E2wyDBUlS86YF_glUnQxyDCyrf2wJ2Akjqe7If2b9tAXHbSZBcQJFGHENymYhdBW6QObmTRxUsaOX9wdTToFcoHr-FaE4LcP9KuXhxP-gNNyVN7HN0k0WbhAp6CBIoypFCVLIN96EvNIg
</span></span></code></pre></div><ul>
<li>选择<code>ALL namespace</code>，可以查看如下图</li>
</ul>
<p><a href="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20230421165240.png"  target="_blank" rel="noopener" style="color:#42b983" ;><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20230421165240.png" alt="1"  />
</a></p>
<h2 id="集群优化可选">集群优化(可选)<a hidden class="anchor" aria-hidden="true" href="#集群优化可选">#</a></h2>
<p>Docker可在<code>/etc/docker/daemon.json</code>自定义优化配置，所有配置可见：<a href="https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-configuration-file"  target="_blank" rel="noopener" style="color:#42b983" ;>官方docker configuration</a>，docker常用优化配置见下方注释说明。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># （！！！如果使用docker作为Runtime的话）优化docker配置</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /etc/docker/daemon.json文件，按需配置，不需要全部都照抄，使用时删除注释，因为JSON文件不支持注释</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;exec-opts&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#f92672">]</span>, <span style="color:#75715e"># cgroups驱动</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;registry-mirrors&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;https://ynirk4k5.mirror.aliyuncs.com&#34;</span><span style="color:#f92672">]</span>, <span style="color:#75715e"># 镜像加速器地址</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;allow-nondistributable-artifacts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;api-cors-header&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;authorization-plugins&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;bip&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;bridge&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cgroup-parent&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cluster-advertise&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cluster-store&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;cluster-store-opts&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;containerd&#34;</span>: <span style="color:#e6db74">&#34;/run/containerd/containerd.sock&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;containerd-namespace&#34;</span>: <span style="color:#e6db74">&#34;docker&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;data-root&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#75715e"># 数据根目录，大量docker镜像可能会占用较大存储，可以设置系统盘外的挂载盘</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;debug&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-address-pools&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;base&#34;</span>: <span style="color:#e6db74">&#34;172.30.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;size&#34;</span>: <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;base&#34;</span>: <span style="color:#e6db74">&#34;172.31.0.0/16&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;size&#34;</span>: <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-cgroupns-mode&#34;</span>: <span style="color:#e6db74">&#34;private&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway-v6&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-runtime&#34;</span>: <span style="color:#e6db74">&#34;runc&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-shm-size&#34;</span>: <span style="color:#e6db74">&#34;64M&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-ulimits&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;nofile&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Hard&#34;</span>: 64000,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;nofile&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Soft&#34;</span>: <span style="color:#ae81ff">64000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;dns&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;dns-opts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;dns-search&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;exec-root&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;experimental&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;features&#34;</span>: <span style="color:#f92672">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fixed-cidr&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;fixed-cidr-v6&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;group&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;hosts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;icc&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;init&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;init-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-init&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;insecure-registries&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip-forward&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip-masq&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;iptables&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ip6tables&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;ipv6&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;labels&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;live-restore&#34;</span>: true, <span style="color:#75715e"># docker进程宕机时容器依然保持存活</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-driver&#34;</span>: <span style="color:#e6db74">&#34;json-file&#34;</span>, <span style="color:#75715e"># 日志格式</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-level&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#75715e"># 日志级别</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-opts&#34;</span>: <span style="color:#f92672">{</span> <span style="color:#75715e"># 日志优化</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-disabled&#34;</span>: <span style="color:#e6db74">&#34;false&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-size&#34;</span>: <span style="color:#e6db74">&#34;20m&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-compress&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;env&#34;</span>: <span style="color:#e6db74">&#34;os,customer&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;labels&#34;</span>: <span style="color:#e6db74">&#34;somelabel&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>, <span style="color:#75715e"># 最大日志数量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-size&#34;</span>: <span style="color:#e6db74">&#34;10m&#34;</span> <span style="color:#75715e"># 保存的最大日志大小</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-downloads&#34;</span>: 3, <span style="color:#75715e"># pull下载并发数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-uploads&#34;</span>: 5, <span style="color:#75715e"># push上传并发数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-download-attempts&#34;</span>: 5,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;mtu&#34;</span>: 0,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;no-new-privileges&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;node-generic-resources&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;NVIDIA-GPU=UUID1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;NVIDIA-GPU=UUID2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;oom-score-adjust&#34;</span>: -500,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;pidfile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;raw-logs&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;runtimes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cc-runtime&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/bin/cc-runtime&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;custom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/local/bin/my-runc-replacement&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;runtimeArgs&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;--debug&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;seccomp-profile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;selinux-enabled&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;shutdown-timeout&#34;</span>: 15,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-driver&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-opts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;swarm-default-advertise-addr&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tls&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlscacert&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlscert&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlskey&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;tlsverify&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userland-proxy&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userland-proxy-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-proxy&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userns-remap&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 无注释版</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;exec-opts&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;registry-mirrors&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;https://ynirk4k5.mirror.aliyuncs.com&#34;</span><span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;containerd-namespace&#34;</span>: <span style="color:#e6db74">&#34;docker&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;data-root&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;debug&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-cgroupns-mode&#34;</span>: <span style="color:#e6db74">&#34;private&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-gateway-v6&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-runtime&#34;</span>: <span style="color:#e6db74">&#34;runc&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-shm-size&#34;</span>: <span style="color:#e6db74">&#34;64M&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;default-ulimits&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;nofile&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Hard&#34;</span>: 64000,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;nofile&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;Soft&#34;</span>: <span style="color:#ae81ff">64000</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;init-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-init&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;live-restore&#34;</span>: true,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-driver&#34;</span>: <span style="color:#e6db74">&#34;json-file&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-level&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;log-opts&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-disabled&#34;</span>: <span style="color:#e6db74">&#34;false&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-max-size&#34;</span>: <span style="color:#e6db74">&#34;20m&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cache-compress&#34;</span>: <span style="color:#e6db74">&#34;true&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;env&#34;</span>: <span style="color:#e6db74">&#34;os,customer&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;labels&#34;</span>: <span style="color:#e6db74">&#34;somelabel&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-file&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;max-size&#34;</span>: <span style="color:#e6db74">&#34;10m&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-downloads&#34;</span>: 3,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-concurrent-uploads&#34;</span>: 5,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;max-download-attempts&#34;</span>: 5,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;mtu&#34;</span>: 0,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;no-new-privileges&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;oom-score-adjust&#34;</span>: -500,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;pidfile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;raw-logs&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;runtimes&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;cc-runtime&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/bin/cc-runtime&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;custom&#34;</span>: <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;path&#34;</span>: <span style="color:#e6db74">&#34;/usr/local/bin/my-runc-replacement&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;runtimeArgs&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;--debug&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;seccomp-profile&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;selinux-enabled&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;shutdown-timeout&#34;</span>: 15,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-driver&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;storage-opts&#34;</span>: <span style="color:#f92672">[]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;swarm-default-advertise-addr&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userland-proxy-path&#34;</span>: <span style="color:#e6db74">&#34;/usr/libexec/docker-proxy&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;userns-remap&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置证书有效期</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim /usr/lib/systemd/system/kube-controller-manager.service</span>
</span></span><span style="display:flex;"><span>... <span style="color:#75715e"># 加入下面配置</span>
</span></span><span style="display:flex;"><span>--experimental-cluster-signing-duration<span style="color:#f92672">=</span>876000h0m0s
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># systemctl daemon-reload</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># systemctl restart kube-controller-manager</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubelet优化加密算法，默认的算法容易被漏洞扫描；增长镜像下载周期，避免有些大镜像未下载完成就被动死亡退出</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --image-pull-progress-deadline=30m</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf</span>
</span></span><span style="display:flex;"><span>... <span style="color:#75715e"># 下面这行中KUBELET_EXTRA_ARGS=后加入配置</span>
</span></span><span style="display:flex;"><span>Environment<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;KUBELET_EXTRA_ARGS=--tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 --image-pull-progress-deadline=30m&#34;</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 集群配置优化，详见https://kubernetes.io/zh/docs/tasks/administer-cluster/reserve-compute-resources/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># vim /etc/kubernetes/kubelet-conf.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 文件中添加如下配置</span>
</span></span><span style="display:flex;"><span>rotateServerCertificates: true
</span></span><span style="display:flex;"><span>allowedUnsafeSysctls: <span style="color:#75715e"># 允许在修改内核参数，此操作按情况选择，用不到就不用设置</span>
</span></span><span style="display:flex;"><span> - <span style="color:#e6db74">&#34;net.core*&#34;</span>
</span></span><span style="display:flex;"><span> - <span style="color:#e6db74">&#34;net.ipv4.*&#34;</span>
</span></span><span style="display:flex;"><span>kubeReserved: <span style="color:#75715e"># 为Kubernetes集群守护进程组件预留资源，例如：kubelet、Runtime等</span>
</span></span><span style="display:flex;"><span>  cpu: <span style="color:#e6db74">&#34;100m&#34;</span>
</span></span><span style="display:flex;"><span>  memory: 100Mi
</span></span><span style="display:flex;"><span>  ephemeral-storage: 1Gi
</span></span><span style="display:flex;"><span>systemReserved: <span style="color:#75715e"># 为系统守护进程预留资源，例如：sshd、cron等</span>
</span></span><span style="display:flex;"><span>  cpu: <span style="color:#e6db74">&#34;100m&#34;</span>
</span></span><span style="display:flex;"><span>  memory: 100Mi
</span></span><span style="display:flex;"><span>  ephemeral-storage: 1Gi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 为集群节点打标签，删除标签把 = 换成 - 即可</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node01 node-role.kubernetes.io/node<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-node02 node-role.kubernetes.io/node<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-master01 node-role.kubernetes.io/master<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-master02 node-role.kubernetes.io/master<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>kubectl label nodes k8s-master03 node-role.kubernetes.io/master<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 添加标签后查看集群状态</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get node</span>
</span></span><span style="display:flex;"><span>NAME           STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>k8s-master01   Ready    master   35m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master02   Ready    master   35m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-master03   Ready    master   35m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node01     Ready    node     35m   v1.26.4
</span></span><span style="display:flex;"><span>k8s-node02     Ready    node     35m   v1.26.4
</span></span></code></pre></div><p>生产环境建议ETCD集群和Kubernetes集群分离，而且使用高性能数据盘存储数据，根据情况决定是否将Master节点也作为Pod调度节点。</p>
<h2 id="测试集群">测试集群<a hidden class="anchor" aria-hidden="true" href="#测试集群">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 测试namespace</span>
</span></span><span style="display:flex;"><span>kubectl get namespace
</span></span><span style="display:flex;"><span>kubectl create namespace test
</span></span><span style="display:flex;"><span>kubectl get namespace
</span></span><span style="display:flex;"><span>kubectl delete namespace test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建nginx实例并开放端口</span>
</span></span><span style="display:flex;"><span>kubectl create deployment nginx --image<span style="color:#f92672">=</span>nginx
</span></span><span style="display:flex;"><span>kubectl expose deployment nginx --port<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span> --type<span style="color:#f92672">=</span>NodePort
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看调度状态和端口号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get po,svc -o wide</span>
</span></span><span style="display:flex;"><span>NAME                         READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>pod/nginx-748c667d99-dmtn6   1/1     Running   <span style="color:#ae81ff">0</span>          9m55s   172.25.244.194   k8s-master01   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE   SELECTOR
</span></span><span style="display:flex;"><span>service/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        69m   &lt;none&gt;
</span></span><span style="display:flex;"><span>service/nginx        NodePort    10.110.18.105   &lt;none&gt;        80:31687/TCP   9s    app<span style="color:#f92672">=</span>nginx
</span></span></code></pre></div><p>在浏览器输入<a href="http://%e4%bb%bb%e6%84%8f%e8%8a%82%e7%82%b9IP:31687/"  target="_blank" rel="noopener" style="color:#42b983" ;>http://任意节点IP:31687/</a> 访问nginx，访问结果如图</p>
<p><img loading="lazy" src="https://deemoprobe.oss-cn-shanghai.aliyuncs.com/images/20230421165824.png" alt="20230421165824"  />
</p>
<p>至此，基于二进制方式的Kubernetes高可用集群部署并验证成功。</p>


        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://deemoprobe.github.io/posts/tech/kubernetes/kubernetescli/">
    <span class="title">« 上一页</span>
    <br>
    <span>Kuberntes CLI</span>
  </a>
  <a class="next" href="https://deemoprobe.github.io/posts/tech/kubernetes/kuberneteskubeadminstallation-ha/">
    <span class="title">下一页 »</span>
    <br>
    <span>KubernetesKubeadmInstallation HA</span>
  </a>
</nav>

        </footer>
    </div>
</article>
</main>

<footer class="footer">
    
        <span id="runtime_span"></span>
        <script
            type="text/javascript">function show_runtime() { window.setTimeout("show_runtime()", 1000); X = new Date("1/1/2023 1:00:00"); Y = new Date(); T = (Y.getTime() - X.getTime()); M = 24 * 60 * 60 * 1000; a = T / M; A = Math.floor(a); b = (a - A) * 24; B = Math.floor(b); c = (b - B) * 60; C = Math.floor((b - B) * 60); D = Math.floor((c - C) * 60); runtime_span.innerHTML = "网站已运行" + A + "天" + B + "小时" + C + "分" + D + "秒" } show_runtime();</script>
    
    
    <br>
    <span>
        Copyright
        &copy;
        2022-2023
        <a href="https://deemoprobe.github.io/" style="color:#939393;">William&#39;s Blog</a>
        All Rights Reserved
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"William's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"William's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '📄复制';

        function copyingDone() {
            copybutton.innerText = '👌🏻已复制!';
            setTimeout(() => {
                copybutton.innerText = '📄复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"William's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>

<script>
    $("code[class^=language] ").on("mouseover", function () {
        if (this.clientWidth < this.scrollWidth) {
            $(this).css("width", "135%")
            $(this).css("border-top-right-radius", "var(--radius)")
        }
    }).on("mouseout", function () {
        $(this).css("width", "100%")
        $(this).css("border-top-right-radius", "unset")
    })
</script>
</body>

</html>
